<!DOCTYPE html>
<html lang="en">
<head>
        <title>Alex Minnaar's Blog - Machine Learning, Data Science and Software Engineering - Alex Minnaar</title>
        <meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <link rel="shortcut icon" href="http://launchyard.com/images/favicon.png"/>
        <link rel="stylesheet" href="/theme/css/main.css" type="text/css" />

        <!--[if IE]>
                <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

        <!--[if lte IE 7]>
                <link rel="stylesheet" type="text/css" media="all" href="/css/ie.css"/>
                <script src="/js/IE8.js" type="text/javascript"></script><![endif]-->

        <!--[if lt IE 7]>
                <link rel="stylesheet" type="text/css" media="all" href="/css/ie6.css"/><![endif]-->
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.8/jquery.min.js" type="text/javascript"></script>


</head>

<body id="index" class="home">
	
  <!--      <header id="banner" class="body">
                <h1><a href="/"><img src="http://www.launchyard.com/images/logo.png" /></a></h1>
        </header> -->
<!-- /#banner -->
	      <div class="LaunchyardDetail"><p><a href="/"></a>
<a class="title" href="http://alexminnaar.github.io/">Alex Minnaar</a>
<br/>
Machine Learning at University College London. Research Engineer at Nitro.
<br/>
<br/>
<a href="mailto:minnaaralex@gmail.com">Email</a><br />
<a href="https://github.com/alexminnaar">Github</a><br/>
<a href="https://ca.linkedin.com/pub/alex-minnaar/56/a23/853">LinkedIn</a><br/>
</p>


<div id="recent_posts">
			<h3>Categories</h3>
			<div align="left">
			<ul>
				<li><a href="/tag/nlp.html">Topic Modeling</a></li>
                <li><a href="/tag/deep-learning.html">Deep Learning</a></li>
				<li><a href="/tag/supervised-learning.html">Supervised Learning</a></li>
				<li><a href="/tag/bayesian-inference.html">Bayesian Inference</a></li>
				<li><a href="/tag/kaggle-competitions.html">Kaggle Competitions</a></li>
				<li><a href="/tag/software-engineering.html">Software Engineering</a></li>
			</ul>
			</div>
              <h3>Recent Posts</h3>
                <a href="implementing-distbelief-with-akka.html">Implementing the DistBelief Deep Neural Network Training Framework with Akka</a><br /><br />
                <a href="word2vec-tutorial-part-ii-the-continuous-bag-of-words-model.html">Word2Vec Tutorial Part II: The Continuous Bag-of-Words Model</a><br /><br />
                <a href="word2vec-tutorial-part-i-the-skip-gram-model.html">Word2Vec Tutorial Part I: The Skip-Gram Model</a><br /><br />
                <a href="distributed-online-latent-dirichlet-allocation-with-apache-spark.html">Distributed Online Latent Dirichlet Allocation with Apache Spark</a><br /><br />
                <a href="deep-learning-basics-neural-networks-backpropagation-and-stochastic-gradient-descent.html">Deep Learning Basics: Neural Networks, Backpropagation and Stochastic Gradient Descent</a><br /><br />
                <a href="building-a-shoutbox-app-with-cassandra-and-nodejs.html">Building a Shoutbox App with Cassandra and Node.js</a><br /><br />
                <a href="/building-a-distributed-binary-search-tree-with-akka.html">Building a Distributed Binary Search Tree with Akka</a><br /><br />
                <a href="/introduction-to-the-multithreading-problem-and-the-akka-actor-solution.html">Introduction to the Multithreading Problem and the Akka Actor Solution  </a><br /><br />
                <a href="/scalaner-a-scala-wrapper-for-the-stanford-ner-tool-with-some-added-features.html">ScalaNER: A Scala Wrapper for the Stanford NER Tool with Some Added Features  </a><br /><br />
                <a href="/online-latent-dirichlet-allocation-the-best-option-for-topic-modeling-with-large-data-sets.html">Online Latent Dirichlet Allocation - The Best Option for Topic Modeling with Large Data Sets  </a><br /><br />
                <a href="/latent-dirichlet-allocation-in-scala-part-ii-the-code.html">Latent Dirichlet Allocation in Scala Part II - The Code </a><br /><br />
          </div>

</div>

        
        

    
            <aside id="featured">
                <div class="body">
                    <article>
                        <h1 class="entry-title"><a href="/building-a-shoutbox-app-with-cassandra-and-nodejs.html">Building a Shoutbox App with Cassandra and Node.js</a></h1>
<div class="post-info">
	<ul>
        <li class="vcard author">
                 by&nbsp;<a class="url fn" href="/author/alex-minnaar.html">Alex Minnaar</a>
        </li>
        <li class="published" title="2015-02-08T00:00:00+01:00">
          on&nbsp;Sun 08 February 2015
        </li>

	</ul>
<p>Category: <a href="/tag/software-engineering.html">   Software Engineering</a></p>
</div><!-- /.post-info --><p>In this blog post I wanted to provide a demonstration of how to use the Cassandra database system in a practical web application.  We'll create a shoutbox app which you can think of as a very simple version of Twitter.</p>
<h1>What is Cassandra?</h1>
<p>Cassandra is a NoSQL distributed database system that is designed to deal with large amounts of data.  Its key advantages are the following.</p>
<ul>
<li><strong>Scalability:</strong>  Allows you to increase capacity by adding cheap commodity hardware without any downtime.</li>
<li><strong>Fault Tolerant:</strong>  There is data replications and no single point of failure so if a node goes down the system remains operational.</li>
<li><strong>Linear Performance:</strong> Throughput increases linearly with the number of nodes in the cluster.</li>
<li><strong>Data Flexibility:</strong>  Supports many data formats and allows for a variable number of columns for each row.</li>
</ul>
<p>In terms of the <a href="http://en.wikipedia.org/wiki/CAP_theorem">CAP theorem</a>, Cassandra values availability and partition tolerance at the expence of consistency.  This means that Cassandra uses <em>eventual consistency</em> which means that eventually the system will reach a consistent state but at any given time it is possible that different nodes can hold different versions of the same data.  The actual architecture of Cassandra is beyond the scope of this blog post but it involves commit logs, memtables, and peer-to-peer gossip protocols.</p>
<h1>How does Cassandra Work?</h1>
<h2>Column Families</h2>
<p>Column families are similar to RDMS tables.  Cassandra is a <em>column-oriented</em> database which means that columns are defined beforehand as well as the data format that each column can hold.  Unlike the RDMS system, rows in Cassandra can contain any number of columns in any order like in the following example.</p>
<p><img alt="column family example" src="images/static_column_family.png" /></p>
<p>Cassandra also offers <em>dynamic</em> column families which allows the user to create a row that contains precomputed results that can be quickly retrieved.  This is why Cassandra is described as a <em>key-value</em> database where column <em>values</em> can be quickly lookedup by their associated row <em>key</em>. </p>
<h2>Keyspaces</h2>
<p>Cassandra Keyspaces are similar to schemas in RDMS databases.  A keyspace groups and applications column families together.  Replication is done on a <em>per-keyspace</em> basis so data that resides in the same keyspace is replicated in the same way.  There is usually one keyspace per application.</p>
<h2>Denormalization</h2>
<p>One of the disadvantages of Cassandra compared to RDMS databases is that it is not well-suited for ad-hoc complex queries.  As a result you must know what queries you will need to perform beforehand and create your keyspaces accordingly.  Cassandra does not have the same foreign key relationships that RDMS databases have therefore you cannot <em>join</em> multiple column families.  As a consequence, the data that you want to retrieve in your queries should be contained in the same column family.  Therefore the queries that you plan on performing will define your data model.</p>
<h1>Building a Shoutbox App</h1>
<p>Say you have developed a Twitter-like app where users can post their thoughts (shouts) as well as follow other users.  Let's also assume that this app has exploded in popularity to the point where RDMS systems can no longer handle the huge amount of data so you turn to Cassandra.  Let's learn how an app such as this can interact with Cassandra.</p>
<h2>Queries we will Use</h2>
<p>As stated previously, Cassandra uses denormalization which means that we need to first decide what queries we want to perform, then optimize our data model according to these queries.  In our shoutbox app we would like to</p>
<ul>
<li>Show all users.</li>
<li>Show who a user is following.</li>
<li>Show who is following a user.</li>
<li>Show the shouts of a particular user.</li>
<li>Show all shouts.</li>
</ul>
<p>Consequently, we will create the following column families to accomodate these queries.</p>
<ul>
<li><strong>USERS</strong> which will contain <em>username</em> and <em>password</em> columns.</li>
<li><strong>FOLLOWING</strong> which will contain <em>username</em> and <em>followed</em> columns.</li>
<li><strong>FOLLOWERS</strong> which will contain <em>username</em> and <em>following</em> columns.</li>
<li><strong>SHOUTS</strong> which will contain <em>shout_id</em>, <em>username</em>, and <em>body</em> columns.</li>
<li><strong>USERSHOUTS</strong> which will contain <em>username</em>, <em>shout_id</em>, and <em>body</em> columns.</li>
<li><strong>SHOUTWALL</strong> which will contain <em>username</em>, <em>shout_id</em>, <em>posted_by</em> and <em>body</em> columns.</li>
</ul>
<p>It may seem redundant to create all of these column families from the RDMS perspective but denomalization is necessary in Cassandra.</p>
<h2>Creating the Column Families</h2>
<p>We can actually create these column families using the CQL shell.  But first we have to create the keyspace for our app which we will call <code>shoutkeyspace</code>.</p>
<div class="highlight"><pre>CREATE KEYSPACE shoutkeyspace WITH REPLICATION - {&#39;class&#39; : &#39;SimpleStrategy&#39;, &#39;replication_factor&#39; : 3};
</pre></div>


<p>In this example we will not be using multiple data centers so <code>SimpleStrategy</code> replication is used rather than  <code>NetworkTopology</code>.  We also use a <code>replication_factor</code> of 3 which indicates that our data will be replicated 3 times in our cluster.  We will use this keyspace to create our column families with the <code>USE shoutkeyspace;</code> command.</p>
<p>Let's first create the <strong>USERS</strong> column family.</p>
<div class="highlight"><pre>CREATE TABLE users(username text PRIMARY KEY, password text);
</pre></div>


<p>and now the <strong>FOLLOWING</strong> column family.</p>
<div class="highlight"><pre>CREATE TABLE following(username text PRIMARY KEY, followed text);
</pre></div>


<p>and now the <strong>FOLLOWERS</strong> column family.</p>
<div class="highlight"><pre>CREATE TABLE followers(username text PRIMARY KEY, following text);
</pre></div>


<p>and now the <strong>SHOUTS</strong> column family.</p>
<div class="highlight"><pre>CREATE TABLE shouts(shout_id uuid PRIMARY KEY, username text, body text);
</pre></div>


<p>and now the <strong>USERSHOUTS</strong> column family.</p>
<div class="highlight"><pre>CREATE TABLE usershouts(username text, shout_id timeuuid, body text, PRIMARY KEY(username, shout_id));
</pre></div>


<p>and finally the <strong>SHOUTWALL</strong> column family.</p>
<div class="highlight"><pre>CREATE TABLE shoutwall(username text, shout_id timeuuid, posted_by text, body text, PRIMARY KEY(username, shout_id));
</pre></div>


<p>The columns associated with a <code>PRIMARY KEY</code> indicate the fields by which we will want to search our column families in our queries.</p>
<h2>Inserting/Selecting Data</h2>
<p>Inserting data into these column families will be done within the Node.js application but here is an example CQL statment to give you some idea.</p>
<div class="highlight"><pre>INSERT INTO users(username, password) VALUES (&#39;user1&#39;, &#39;password1&#39;);
</pre></div>


<p>Obviously this example is purely instructive and in a real-world application more security would be used with respect to storing passwords.  You can also use batch commands to insert multiple values at once.  Selecting data can also be done with the normal SQL syntax, note however that <code>WHERE</code> clauses can only be applied to indexed fields (i.e. fields that are assigned a primary key).</p>
<h1>Creating the Node.js Frontend</h1>
<p>The first step in creating a Node.js frontend that interacts with Cassandra is adding the <a href="https://github.com/datastax/nodejs-driver">Node.js Cassandra client driver</a> to the <em>package.json</em> file.  This driver will enable us to connect with the Cassandra database that we have just created.  This can be done with the following code which should be added to the <em>app.js</em> file as well as any javascript file in which a Cassandra connection is made.</p>
<div class="highlight"><pre><span class="kd">var</span> <span class="nx">client</span><span class="o">=</span><span class="k">new</span> <span class="nx">cassandra</span><span class="p">.</span><span class="nx">Client</span><span class="p">({</span><span class="nx">contactPoint</span> <span class="o">:</span> <span class="p">[</span><span class="s1">&#39;127.0.0.1&#39;</span><span class="p">]});</span>
<span class="nx">client</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span><span class="nx">result</span><span class="p">){</span>
    <span class="nx">consolde</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;cassandra connected&#39;</span><span class="p">)</span>
<span class="p">});</span>
</pre></div>


<p>Note that in the above code we are connecting to a local instance of Cassandra.  This <code>client</code> variable is what we will be using to execute our Cassandra queries</p>
<h2>Displaying Users</h2>
<p>The most basic function that we want our app to perform is displaying all of the users.  To this end, we create a <em>users.js</em> file in the <em>routes</em> folder and add the following code.</p>
<div class="highlight"><pre><span class="kd">var</span> <span class="nx">getAllUsers</span> <span class="o">=</span> <span class="s1">&#39;SELECT * FROM shoutkeyspace.users&#39;</span><span class="p">;</span>

<span class="nx">router</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">client</span><span class="p">.</span><span class="nx">execute</span><span class="p">(</span><span class="nx">getAllUsers</span><span class="p">,[],</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">){</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">){</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">404</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="nx">msg</span><span class="o">:</span> <span class="nx">err</span><span class="p">});</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span><span class="s1">&#39;users&#39;</span><span class="p">,{</span>
            <span class="nx">users</span><span class="o">:</span> <span class="nx">result</span><span class="p">.</span><span class="nx">rows</span>
        <span class="p">});</span>
    <span class="p">}</span>
  <span class="p">});</span>
<span class="p">});</span>
</pre></div>


<p>As you can see, the query to select all rows from the <code>users</code> column family is first saved as a string variable.  Then inside the <code>router.get()</code> function, the Cassandra <code>client</code> variable that we defined eariler executes this query and if it is successfull, the corresponding <code>users</code> view is rendered with the query result.  The <code>users</code> view is a <em>jade</em> file and for the purposes of this example it is very simple.</p>
<div class="highlight"><pre>block content
    h1 Users
    ul
        each user, i in users
            li #{user.username}
</pre></div>


<p>The <code>each user, i in users</code> line loops through the query result from <em>users.js</em> and the resulting usernames are displayed in a list with <code>#{user.username}</code>.</p>
<h2>Selecting Individual Users</h2>
<p>Next we want to be able to select individual users from this list which will navigate us to a new page showing the selected user's information.  We create a new file in the <em>routes</em> folder called <em>user.js</em> and the code is very similar to what we have seen before.</p>
<div class="highlight"><pre><span class="kd">var</span> <span class="nx">getByUsername</span> <span class="o">=</span> <span class="s1">&#39;SELECT * FROM shoutkeyspace.users WHERE username = ?&#39;</span><span class="p">;</span>

<span class="nx">router</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/:username&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">){</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">execute</span><span class="p">(</span><span class="nx">getByUsername</span><span class="p">,[</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">username</span><span class="p">],</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">){</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">){</span>
            <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">404</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="nx">msg</span><span class="o">:</span> <span class="nx">err</span><span class="p">});</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">res</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span><span class="s1">&#39;user&#39;</span><span class="p">,{</span>
                <span class="nx">username</span><span class="o">:</span> <span class="nx">result</span><span class="p">.</span><span class="nx">rows</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">username</span><span class="p">,</span>
                <span class="nx">email</span><span class="o">:</span> <span class="nx">result</span><span class="p">.</span><span class="nx">rows</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">email</span><span class="p">,</span>
                <span class="nx">full_name</span><span class="o">:</span> <span class="nx">result</span><span class="p">.</span><span class="nx">rows</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">full_name</span>
            <span class="p">});</span>
        <span class="p">}</span>
    <span class="p">});</span>
<span class="p">});</span>
</pre></div>


<p>You may have noticed the strange <code>WHERE username = ?</code> in the query string.  This is because we have to be told which username we are selecting.  This variable is passed into our query by the <code>[req.params.username]</code> parameter.  If the query is executed successfully, the specified user's <code>username</code>, <code>email</code>, and <code>full_name</code> fields are sent to the <em>user</em> view.  Again, the view is quite simple.  It simply displays the fields sent to it in <em>user.js</em>.</p>
<div class="highlight"><pre>block content
    h1 User Info
    ul
        li Name:
            strong #{full_name}
        li Username:
            strong #{username}
        li Email Address
            strong #{email}
</pre></div>


<h2>Adding Users</h2>
<p>Just like before we need to add a route and a view for adding a user.  Let's call the route <em>adduser.js</em>.  This will involve both a <em>GET</em> and a <em>POST</em> HTTP request - we need to get the data from the <em>adduser</em> form and then post it to Cassandra.</p>
<div class="highlight"><pre><span class="nx">router</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">){</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span><span class="s1">&#39;adduser&#39;</span><span class="p">);</span>
<span class="p">});</span>

<span class="kd">var</span> <span class="nx">upsertUser</span>  <span class="o">=</span> <span class="s1">&#39;INSERT INTO shoutkeyspace.users(username, password, email, full_name) VALUES(?,?,?,?)&#39;</span><span class="p">;</span>

<span class="nx">router</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">){</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">execute</span><span class="p">(</span><span class="nx">upsertUser</span><span class="p">,</span> <span class="p">[</span><span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">username</span><span class="p">,</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">password</span><span class="p">,</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">email</span><span class="p">,</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">full_name</span><span class="p">],</span>
        <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">){</span>
            <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">){</span>
                <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">404</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="nx">msg</span><span class="o">:</span> <span class="nx">err</span><span class="p">});</span>
            <span class="p">}</span> <span class="k">else</span><span class="p">{</span>
                <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;User Added&#39;</span><span class="p">);</span>
                <span class="nx">res</span><span class="p">.</span><span class="nx">redirect</span><span class="p">(</span><span class="s1">&#39;/users&#39;</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">});</span>
<span class="p">});</span>
</pre></div>


<p>So first we use use a GET request to render the <em>adduser</em> view.  This view contains the form where the required data is added (<em>username</em>, <em>password</em>, <em>email</em>, <em>full_name</em>).</p>
<div class="highlight"><pre>block content
    h1 Add User
    form#formAddUser(name=&quot;adduser&quot;, method=&quot;post&quot;, action=&quot;/adduser&quot;)
        div
            input#inputUserName(type=&quot;text&quot;, placeholder=&quot;Enter Username&quot; name=&quot;username&quot;)
        div
            input#inputPassword(type=&quot;password&quot;, placeholder=&quot;Enter Password&quot; name=&quot;password&quot;)
        div
            input#inputEmail(type=&quot;text&quot;, placeholder=&quot;Enter Email&quot; name=&quot;email&quot;)
        div
            input#inputFullName(type=&quot;text&quot;, placeholder=&quot;Enter Full Name&quot; name=&quot;full_name&quot;)
        div
            button#btnSubmit(type=&quot;submit&quot;) Submit
</pre></div>


<p>Then we define our query to insert a new user into our Cassandra <em>users</em> column family. We then execute this query with the required fields and if successfull we redirect to the <em>users</em> view which should now contain our new user.</p>
<h2>Updating Users</h2>
<p>We also want the ability for a user to update their information. To edit a user's information, we want to present the same form as when the user was intially added with the same information already in the form's fields so that modification is easy.  Again, let's make an <em>edituser</em> route and view.  The <em>edituser.js</em> route looks like the following.</p>
<div class="highlight"><pre><span class="kd">var</span> <span class="nx">getByUsername</span> <span class="o">=</span> <span class="s1">&#39;SELECT * FROM shoutkeyspace.users WHERE username = ?&#39;</span><span class="p">;</span>

<span class="nx">router</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/:username&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">){</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">execute</span><span class="p">(</span><span class="nx">getByUsername</span><span class="p">,[</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">username</span><span class="p">],</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span><span class="nx">result</span><span class="p">){</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">){</span>
            <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">404</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="nx">msg</span><span class="o">:</span> <span class="nx">err</span><span class="p">});</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">res</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span><span class="s1">&#39;edituser&#39;</span><span class="p">,</span> <span class="p">{</span>
                <span class="nx">username</span><span class="o">:</span> <span class="nx">result</span><span class="p">.</span><span class="nx">rows</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">username</span><span class="p">,</span>
                <span class="nx">email</span><span class="o">:</span> <span class="nx">result</span><span class="p">.</span><span class="nx">rows</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">email</span><span class="p">,</span>
                <span class="nx">full_name</span><span class="o">:</span> <span class="nx">result</span><span class="p">.</span><span class="nx">rows</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">full_name</span><span class="p">,</span>
                <span class="nx">password</span><span class="o">:</span> <span class="nx">result</span><span class="p">.</span><span class="nx">rows</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">password</span>
            <span class="p">});</span>
        <span class="p">}</span>
    <span class="p">});</span>
<span class="p">});</span>

<span class="kd">var</span> <span class="nx">upsertUser</span>  <span class="o">=</span> <span class="s1">&#39;INSERT INTO shoutkeyspace.users(username, password, email, full_name) VALUES(?,?,?,?)&#39;</span><span class="p">;</span>

<span class="nx">router</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">){</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">execute</span><span class="p">(</span><span class="nx">upsertUser</span><span class="p">,</span> <span class="p">[</span><span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">username</span><span class="p">,</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">password</span><span class="p">,</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">email</span><span class="p">,</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">full_name</span><span class="p">],</span>
        <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">){</span>
            <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">){</span>
                <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">404</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="nx">msg</span><span class="o">:</span> <span class="nx">err</span><span class="p">});</span>
            <span class="p">}</span> <span class="k">else</span><span class="p">{</span>
                <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;User Updated&#39;</span><span class="p">);</span>
                <span class="nx">res</span><span class="p">.</span><span class="nx">redirect</span><span class="p">(</span><span class="s1">&#39;/user/&#39;</span><span class="o">+</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">username</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">});</span>
<span class="p">});</span>
</pre></div>


<p>First we execute a Cassandra query to get the information needed to populate the form.  When this is executed, the <em>edituser</em> view is rendered with form information from the query result appearing in the fields.  The rest is exactly the same as <em>adduser</em>.  Furthermore, the <em>edituser</em> view is almost exactly the same as the <em>adduser.js</em> view (with <code>action=/adduser</code> replaced with <code>action=/edituser</code> and the passed in values added) so I will not show it.</p>
<h2>Deleting Users</h2>
<p>We also want to be able to delete users.  To do this we add the following code to the <em>user.js</em> route.</p>
<div class="highlight"><pre><span class="kd">var</span> <span class="nx">deleteUser</span> <span class="o">=</span> <span class="s2">&quot;DELETE FROM shoutkeyspace.users WHERE username = ?&quot;</span><span class="p">;</span>

<span class="nx">router</span><span class="p">.</span><span class="k">delete</span><span class="p">(</span><span class="s1">&#39;/:username&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">){</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">execute</span><span class="p">(</span><span class="nx">deleteUser</span><span class="p">,[</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">username</span><span class="p">],</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">){</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">){</span>
            <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">404</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="nx">msg</span><span class="o">:</span> <span class="nx">err</span><span class="p">});</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="nx">result</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">});</span>
<span class="p">});</span>
</pre></div>


<p>First we create the delete query and execute it as usual.  However, we still need a way of creating this <em>DELETE</em> request when the <em>deleteuser</em> button is clicked.  We will do this with JQuery and AJAX.  We create a <em>main.js</em> file in the <em>/public/javascripts</em> folder which contains the following JQuery code.</p>
<div class="highlight"><pre><span class="nx">$</span><span class="p">(</span><span class="nb">document</span><span class="p">).</span><span class="nx">ready</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
    <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;.deleteuser&#39;</span><span class="p">).</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;click&#39;</span><span class="p">,</span> <span class="nx">deleteUser</span><span class="p">);</span>
<span class="p">});</span>

<span class="kd">function</span> <span class="nx">deleteUser</span><span class="p">(){</span>
    <span class="nx">event</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">();</span>

    <span class="kd">var</span> <span class="nx">confirmation</span> <span class="o">=</span> <span class="nx">confirm</span><span class="p">(</span><span class="s1">&#39;Are you sure that you want to delete this user?&#39;</span><span class="p">);</span>

    <span class="k">if</span><span class="p">(</span><span class="nx">confirmation</span><span class="p">){</span>
        <span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">({</span>
            <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;DELETE&#39;</span><span class="p">,</span>
            <span class="nx">url</span><span class="o">:</span> <span class="s1">&#39;/user/&#39;</span><span class="o">+</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;.deleteuser&#39;</span><span class="p">).</span><span class="nx">data</span><span class="p">(</span><span class="s1">&#39;user&#39;</span><span class="p">)</span>
        <span class="p">}).</span><span class="nx">done</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">response</span><span class="p">){</span>
            <span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="s1">&#39;/users&#39;</span><span class="p">);</span>
        <span class="p">});</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<p>So when the <em>deleteuser</em> button is clicked, the <em>deleteUser()</em> function is called which uses AJAX to send the <em>DELETE</em> request to the correct URL.</p>
<h2>Displaying Shouts</h2>
<p>Now let's turn our attention to displaying shouts.  Again we must create a <em>shouts</em> route and view.  Our <em>shouts.js</em> route should look like the following.</p>
<div class="highlight"><pre><span class="kd">var</span> <span class="nx">getAllShouts</span> <span class="o">=</span> <span class="s1">&#39;SELECT * FROM shoutkeyspace.shouts&#39;</span><span class="p">;</span>

<span class="nx">router</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">){</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">execute</span><span class="p">(</span><span class="nx">getAllShouts</span><span class="p">,[],</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">){</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">){</span>
            <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">404</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="nx">msg</span><span class="o">:</span> <span class="nx">err</span><span class="p">});</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">res</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span><span class="s1">&#39;shouts&#39;</span><span class="p">,{</span>
                <span class="nx">shouts</span><span class="o">:</span> <span class="nx">result</span><span class="p">.</span><span class="nx">rows</span>
            <span class="p">});</span>
        <span class="p">}</span>
    <span class="p">});</span>
<span class="p">});</span>

<span class="kd">var</span> <span class="nx">getUserShouts</span> <span class="o">=</span> <span class="s1">&#39;SELECT * FROM shoutkeyspace.usershouts WHERE username = ?&#39;</span><span class="p">;</span>

<span class="nx">router</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/:username&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">){</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">execute</span><span class="p">(</span><span class="nx">getUserShouts</span><span class="p">,</span> <span class="p">[</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">username</span><span class="p">],</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">){</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">){</span>
            <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">404</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="nx">msg</span><span class="o">:</span> <span class="nx">err</span><span class="p">});</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">res</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span><span class="s1">&#39;shouts&#39;</span><span class="p">,{</span>
                <span class="nx">shouts</span><span class="o">:</span> <span class="nx">result</span><span class="p">.</span><span class="nx">rows</span>
            <span class="p">});</span>
        <span class="p">}</span>
    <span class="p">});</span>
<span class="p">});</span>
</pre></div>


<p>By now, this should be quite straight-forward.  The first <em>GET</em> request displays all shouts to the <em>shouts</em> view from the Cassandra query and the second <em>GET</em> request displays a specified user's shouts to the <em>shouts</em> view from another Cassandra query.</p>
<h2>Adding Shouts</h2>
<p>The final piece of the puzzle is enabling users to add shouts.  On the view side, this can be done with the following form.</p>
<div class="highlight"><pre>form#formAddShout(name=&quot;addshout&quot;, method=&quot;post&quot;, action=&quot;/addshout&quot;)
        div
            select(name=&quot;username&quot;)
                option(value=&quot;devuser1&quot;) devuser1
                option(value=&quot;devuser2&quot;) devuser2
                option(value=&quot;devuser3&quot;) devuser3
                option(value=&quot;devuser4&quot;) devuser4
        br
        div
            textarea(name=&quot;body&quot;, placeholder=&quot;Shout Something!&quot;, cols=&quot;50&quot;, rows=&quot;5&quot;)
        br
        div
            button#btnSubmit(type=&quot;submit&quot;) Submit
</pre></div>


<p>This form contains a textarea in which the user can write their shout as well as the ability to post it as a specific user (ideally you would have a login system but this is beyond the scope of this app).  Next we create the route as the following.</p>
<div class="highlight"><pre><span class="nx">router</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">){</span>
    <span class="kd">var</span> <span class="nx">id1</span> <span class="o">=</span> <span class="nx">cassandra</span><span class="p">.</span><span class="nx">types</span><span class="p">.</span><span class="nx">uuid</span><span class="p">();</span>
    <span class="kd">var</span> <span class="nx">id2</span> <span class="o">=</span> <span class="nx">cassandra</span><span class="p">.</span><span class="nx">types</span><span class="p">.</span><span class="nx">timeuuid</span><span class="p">();</span>

    <span class="kd">var</span> <span class="nx">queries</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="nx">query</span><span class="o">:</span> <span class="s1">&#39;INSERT INTO shoutkeyspace.shouts(shout_id, username, body) VALUES(?,?,?)&#39;</span><span class="p">,</span>
            <span class="nx">params</span><span class="o">:</span><span class="p">[</span><span class="nx">id1</span><span class="p">,</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">username</span><span class="p">,</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">body</span><span class="p">]</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="nx">query</span><span class="o">:</span> <span class="s1">&#39;INSERT INTO shoutkeyspace.usershouts(username, shout_id, body) VALUES(?,?,?)&#39;</span><span class="p">,</span>
            <span class="nx">params</span><span class="o">:</span> <span class="p">[</span><span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">username</span><span class="p">,</span> <span class="nx">id2</span><span class="p">,</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">body</span><span class="p">]</span>
        <span class="p">}</span>
    <span class="p">];</span>
    <span class="nx">queryOptions</span> <span class="o">=</span> <span class="p">{};</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">batch</span><span class="p">(</span><span class="nx">queries</span><span class="p">,</span> <span class="nx">queryOptions</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">){</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">redirect</span><span class="p">(</span><span class="s1">&#39;/shouts&#39;</span><span class="p">);</span>
    <span class="p">});</span>
<span class="p">});</span>
</pre></div>


<p>Here we use a Cassandra batch query to insert the added shout into both the <code>shouts</code> and <code>usershouts</code> keyspaces.</p>
<p>And that covers the basic functionality of our simple shoutbox app.  In summary, we have given a brief overview of Cassandra, added our keyspaces and column families for our app as well a built a Node.js frontend to connect with our Cassandra database.</p>
<h2>References</h2>
<ul>
<li><a href="https://github.com/alexminnaar/shoutApp">Github repo</a> for the code used in this blog post.</li>
<li><a href="http://www.datastax.com/">Datastax</a> where you can download the free Cassandra community edition as well as learn more about Cassandra.</li>
<li><a href="http://nodejs.org/">nodejs.org</a> where you can download and learn more about Node.js. </li>
</ul>
                    </article>
                </div>
            </aside><!-- /#featured -->
            
        
        

    
            <aside id="featured">
                <div class="body">
                    <article>
                        <h1 class="entry-title"><a href="/building-a-distributed-binary-search-tree-with-akka.html">Building a Distributed Binary Search Tree with Akka</a></h1>
<div class="post-info">
	<ul>
        <li class="vcard author">
                 by&nbsp;<a class="url fn" href="/author/alex-minnaar.html">Alex Minnaar</a>
        </li>
        <li class="published" title="2015-01-05T00:00:00+01:00">
          on&nbsp;Mon 05 January 2015
        </li>

	</ul>
<p>Category: <a href="/tag/software-engineering.html">   Software Engineering</a></p>
</div><!-- /.post-info --><p>In this blog post I will descibe an interesting Akka mini-project that I came across which helped me gain a deeper understanding of Akka's asynchronous actor model.  In this project we use Akka to build a distributed binary search tree where each node in the tree is an actor which allows it to be a completely asynchronous, concurrent, and distributed version of the traditional data structure.  But before we get into the Akka stuff, it would be helpful to remind ourselves of some of the basic properties of a binary search tree.</p>
<h2>Binary Search Tree Basics</h2>
<p>A binary search tree is a tree-based data structure with the following properites</p>
<ol>
<li>Each node in the tree stores an element and can have at most two child nodes.</li>
<li>The tree does not contain any duplicate values.</li>
<li>Elements in a node's left subtree are strictly smaller than the node's element.</li>
<li>Elements in a node's right subtree are strictly greater than the node's element.</li>
</ol>
<p><img alt="binary search tree" src="images/Binary_search_tree.svg" /> </p>
<p>There are also three main tasks a binary search tree can perform.</p>
<ul>
<li><strong>Contains</strong>: Determine if a node containing a particular element exists in the tree by performing a binary tree search.  This is done by starting at the root node and recursively searching the tree by selecting the left or right subtree based on the node's value and the value that we are searching for.  We know that the value does not exist in the tree if we reach an external node and have not yet found it. </li>
<li><strong>Insert</strong>: Insert a new node in the correct place in the tree given its value.  This is also done with a tree search.  Assuming the element does not already exist in the tree, we search for the value that we wish to insert until we arrive at an external node at which point we add the new node as its right or left child depending on its value.</li>
<li><strong>Remove</strong>: Remove an element from the tree and rearrange the remaining nodes in order to keep the desired structure.  If the node you wish to delete is an external node you simply remove it, however if it has children it is more complicated.  One way to deal with this is to identify its in-order predecessor in the left subtree.  This is the greatest element in the left subtree which can be found by recursively selecting the right child within this subtree (in other words it is the right-most element in the left subtree).  This in-order predecessor is then removed (it is an external node so this is simple) and is used to replace the node that is to be deleted.  The opposite procedure would work as well (i.e. replacing the node with its in-order successor in the right subtree).</li>
</ul>
<p>Before we create an Akka application that implements a binary search tree let's briefly review the basics of the actor model.</p>
<h2>Actor Model Basics</h2>
<p>Actors are completely incapsulated, asynchronous entities that are each designed to perform a specific task.  The only way that actors can communicate with each other is through message passing.  Message passing is asynchronous meaning an actor can send a message and then immediately continue performing other tasks (it doesn't have to wait for a response).  When a message is sent to an actor, it is put in a queue and the actor performs the tasks corresponding to each message sequentially, therefore actors are themselves single-threaded.  Furthermore, due to these properties, actors can be distributed in a cluster with essentially the same code as if they were on the same machine which makes things very convenient.</p>
<p>Now let's start to build our Akka application.</p>
<h2>Tree Nodes as Actors</h2>
<p>We will create one main actor called <code>BinaryTreeSet</code> which receives the <code>Contains</code>, <code>Insert</code>, and <code>Remove</code> messages for the entire tree.  As stated previously, each node of the tree will also be an actor which we will call <code>BinaryTreeNode</code>.  Actors usually incapsulate an immutable state.  The <code>BinaryTreeSet</code> actor's state contains the root node of the tree which is a <code>BinaryTreeNode</code> actor.  Each <code>BinaryTreeNode</code> actor's state contains the value that the node holds as well as references to its two children (which are also <code>BinaryTreeNode</code> actors).</p>
<p>Let's first focus on the <code>BinaryTreeSet</code> actor.  An actor class extends Akka's <code>Actor</code> trait and its messages are customarily defined in its companion object as case classes. The following code implements this companion object.</p>
<div class="highlight"><pre><span class="k">object</span> <span class="nc">BinaryTreeSet</span> <span class="o">{</span>

  <span class="k">trait</span> <span class="nc">Operation</span> <span class="o">{</span>
    <span class="k">def</span> <span class="n">requester</span><span class="k">:</span> <span class="kt">ActorRef</span>
    <span class="k">def</span> <span class="n">id</span><span class="k">:</span> <span class="kt">Int</span>
    <span class="k">def</span> <span class="n">elem</span><span class="k">:</span> <span class="kt">Int</span>
  <span class="o">}</span>

  <span class="k">trait</span> <span class="nc">OperationReply</span> <span class="o">{</span>
    <span class="k">def</span> <span class="n">id</span><span class="k">:</span> <span class="kt">Int</span>
  <span class="o">}</span>

  <span class="k">case</span> <span class="k">class</span> <span class="nc">Insert</span><span class="o">(</span><span class="n">requester</span><span class="k">:</span> <span class="kt">ActorRef</span><span class="o">,</span> <span class="n">id</span><span class="k">:</span> <span class="kt">Int</span><span class="o">,</span> <span class="n">elem</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span> <span class="k">extends</span> <span class="nc">Operation</span>
  <span class="k">case</span> <span class="k">class</span> <span class="nc">Contains</span><span class="o">(</span><span class="n">requester</span><span class="k">:</span> <span class="kt">ActorRef</span><span class="o">,</span> <span class="n">id</span><span class="k">:</span> <span class="kt">Int</span><span class="o">,</span> <span class="n">elem</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span> <span class="k">extends</span> <span class="nc">Operation</span>
  <span class="k">case</span> <span class="k">class</span> <span class="nc">Remove</span><span class="o">(</span><span class="n">requester</span><span class="k">:</span> <span class="kt">ActorRef</span><span class="o">,</span> <span class="n">id</span><span class="k">:</span> <span class="kt">Int</span><span class="o">,</span> <span class="n">elem</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span> <span class="k">extends</span> <span class="nc">Operation</span>
  <span class="k">case</span> <span class="k">class</span> <span class="nc">OperationFinished</span><span class="o">(</span><span class="n">id</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span> <span class="k">extends</span> <span class="nc">OperationReply</span>
<span class="o">}</span>
</pre></div>


<p>The <code>Insert</code>, <code>Contains</code>, and <code>Remove</code> messages each have three fields</p>
<ul>
<li><code>requester</code> which is a reference to the actor that sent the request.</li>
<li><code>id</code> which is a unique id for the message.</li>
<li><code>elem</code> which is the value to be inserted (<code>Insert</code>), removed (<code>Remove</code>) or searched for (<code>Contains</code>).</li>
</ul>
<p>There is also an <code>OperationFinished</code> message which is sent back to the <code>BinaryTreeSet</code> actor when the operation specified by the <code>id</code> field is finished.  </p>
<p>Now let's look at the <code>BinaryTreeSet</code> actor class.  </p>
<div class="highlight"><pre><span class="k">class</span> <span class="nc">BinaryTreeSet</span> <span class="k">extends</span> <span class="nc">Actor</span> <span class="o">{</span>
  <span class="k">import</span> <span class="nn">BinaryTreeSet._</span>
  <span class="k">import</span> <span class="nn">BinaryTreeNode._</span>

  <span class="k">def</span> <span class="n">createRoot</span><span class="k">:</span> <span class="kt">ActorRef</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">actorOf</span><span class="o">(</span><span class="nc">BinaryTreeNode</span><span class="o">.</span><span class="n">props</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="n">initiallyRemoved</span> <span class="k">=</span> <span class="kc">true</span><span class="o">))</span>

  <span class="k">var</span> <span class="n">root</span> <span class="k">=</span> <span class="n">createRoot</span>

  <span class="k">def</span> <span class="n">receive</span> <span class="k">=</span> <span class="n">normal</span>

  <span class="k">val</span> <span class="n">normal</span><span class="k">:</span> <span class="kt">Receive</span> <span class="o">=</span> <span class="o">{</span>
    <span class="k">case</span> <span class="n">operation</span><span class="k">:</span> <span class="kt">Operation</span> <span class="o">=&gt;</span> <span class="n">root</span> <span class="o">!</span> <span class="n">operation</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>


<p>Here the tree's root node actor <code>root</code> is created using the <code>context.actorOf</code> method.  The <code>Receive</code> method accepts <code>Operation</code> messages and sends them to <code>root</code>.  Essentially, all messages are sent to the root node and are executed within nodes of the tree which are <code>BinaryTreeNode</code> actors.  So let's look at the <code>BinaryTreeNode</code> implementation.</p>
<div class="highlight"><pre><span class="k">object</span> <span class="nc">BinaryTreeNode</span> <span class="o">{</span>
  <span class="k">trait</span> <span class="nc">Position</span>

  <span class="k">case</span> <span class="k">object</span> <span class="nc">Left</span> <span class="k">extends</span> <span class="nc">Position</span>
  <span class="k">case</span> <span class="k">object</span> <span class="nc">Right</span> <span class="k">extends</span> <span class="nc">Position</span>

  <span class="k">def</span> <span class="n">props</span><span class="o">(</span><span class="n">elem</span><span class="k">:</span> <span class="kt">Int</span><span class="o">,</span> <span class="n">initiallyRemoved</span><span class="k">:</span> <span class="kt">Boolean</span><span class="o">)</span> <span class="k">=</span> <span class="nc">Props</span><span class="o">(</span><span class="n">classOf</span><span class="o">[</span><span class="kt">BinaryTreeNode</span><span class="o">],</span>  <span class="n">elem</span><span class="o">,</span> <span class="n">initiallyRemoved</span><span class="o">)</span>
<span class="o">}</span>
<span class="k">class</span> <span class="nc">BinaryTreeNode</span><span class="o">(</span><span class="k">val</span> <span class="n">elem</span><span class="k">:</span> <span class="kt">Int</span><span class="o">,</span> <span class="n">initiallyRemoved</span><span class="k">:</span> <span class="kt">Boolean</span><span class="o">)</span> <span class="k">extends</span> <span class="nc">Actor</span> <span class="o">{</span>
  <span class="k">import</span> <span class="nn">BinaryTreeNode._</span>
  <span class="k">import</span> <span class="nn">BinaryTreeSet._</span>

  <span class="k">var</span> <span class="n">subtrees</span> <span class="k">=</span> <span class="nc">Map</span><span class="o">[</span><span class="kt">Position</span>, <span class="kt">ActorRef</span><span class="o">]()</span>
  <span class="k">var</span> <span class="n">removed</span> <span class="k">=</span> <span class="n">initiallyRemoved</span>

  <span class="k">def</span> <span class="n">receive</span> <span class="k">=</span> <span class="n">normal</span>

  <span class="k">val</span> <span class="n">normal</span><span class="k">:</span> <span class="kt">Receive</span> <span class="o">=</span> <span class="o">{...}</span>
<span class="o">}</span>
</pre></div>


<p>Where the <code>subtrees</code> map holds the node's left and right children which are themselves <code>BinaryTreeNode</code> actors. The <code>Receive</code> method is left blank so that we can look at the <code>Operation</code> message implementations in more detail.  Let's do this now.</p>
<h3>Contains Messages</h3>
<p>As mentioned previously, a binary tree can be searched by recursively selecting each child depending on the value of the current node and the value of the element that is being searched for until either the element is found or an external node is reached.  The child to select can be found using this simple function</p>
<div class="highlight"><pre><span class="k">def</span> <span class="n">childToVisit</span><span class="o">(</span><span class="n">elemToFind</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span><span class="k">:</span> <span class="kt">Position</span> <span class="o">=</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">elemToFind</span> <span class="o">&gt;</span> <span class="n">elem</span><span class="o">)</span> <span class="nc">Right</span>
    <span class="k">else</span> <span class="nc">Left</span>
<span class="o">}</span>
</pre></div>


<p>We can now implement the functionality to process <code>Contains</code> messages as follows.</p>
<div class="highlight"><pre><span class="k">case</span> <span class="nc">Contains</span><span class="o">(</span><span class="n">requester</span><span class="o">,</span> <span class="n">id</span><span class="o">,</span> <span class="n">elemToFind</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="o">{</span>

      <span class="k">if</span> <span class="o">(</span><span class="n">elem</span> <span class="o">!=</span> <span class="n">elemToFind</span> <span class="o">||</span> <span class="o">(</span><span class="n">elem</span> <span class="o">==</span> <span class="n">elemToFind</span> <span class="o">&amp;&amp;</span> <span class="n">removed</span><span class="o">))</span> <span class="o">{</span>

        <span class="k">val</span> <span class="n">child</span> <span class="k">=</span> <span class="n">childToVisit</span><span class="o">(</span><span class="n">elemToFind</span><span class="o">)</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">subtrees</span><span class="o">.</span><span class="n">contains</span><span class="o">(</span><span class="n">child</span><span class="o">))</span> <span class="o">{</span>
          <span class="n">subtrees</span><span class="o">(</span><span class="n">child</span><span class="o">)</span> <span class="o">!</span> <span class="nc">Contains</span><span class="o">(</span><span class="n">requester</span><span class="o">,</span> <span class="n">id</span><span class="o">,</span> <span class="n">elemToFind</span><span class="o">)</span>
        <span class="o">}</span>
        <span class="k">else</span> <span class="o">{</span>
          <span class="n">requester</span> <span class="o">!</span> <span class="nc">ContainsResult</span><span class="o">(</span><span class="n">id</span><span class="o">,</span> <span class="kc">false</span><span class="o">)</span>
        <span class="o">}</span>
      <span class="o">}</span>
      <span class="k">else</span> <span class="o">{</span>
        <span class="n">requester</span> <span class="o">!</span> <span class="nc">ContainsResult</span><span class="o">(</span><span class="n">id</span><span class="o">,</span> <span class="kc">true</span><span class="o">)</span>
      <span class="o">}</span>
<span class="o">}</span>
</pre></div>


<p>Basically, if the desired value is in the current node and hasn't been removed then the <code>ContainsResult(id, true)</code> message is sent back to the requester.  If it is not and it is not an external node, then the same message is sent to the correct child.  If it is an external node then the element does not exist in the tree and a <code>ContainsResult(id, false)</code> is sent back to the requester.</p>
<h3>Insert Messages</h3>
<p><code>Insert</code> messages can be handled in a similar way.  Again we search the tree and when we get to an external node we create a new <code>BinaryTreeNodeActor</code> that holds the element to insert and add this node to the external node's <code>subtree</code> map.</p>
<div class="highlight"><pre><span class="k">case</span> <span class="nc">Insert</span><span class="o">(</span><span class="n">requester</span><span class="o">,</span> <span class="n">id</span><span class="o">,</span> <span class="n">elemToInsert</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="o">{</span>

      <span class="k">if</span> <span class="o">(</span><span class="n">elem</span> <span class="o">!=</span> <span class="n">elemToInsert</span> <span class="o">||</span> <span class="o">(</span><span class="n">elem</span> <span class="o">==</span> <span class="n">elemToInsert</span> <span class="o">&amp;&amp;</span> <span class="n">removed</span><span class="o">))</span> <span class="o">{</span>

        <span class="k">val</span> <span class="n">child</span> <span class="k">=</span> <span class="n">childToVisit</span><span class="o">(</span><span class="n">elemToInsert</span><span class="o">)</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">subtrees</span><span class="o">.</span><span class="n">contains</span><span class="o">(</span><span class="n">child</span><span class="o">))</span> <span class="o">{</span>
          <span class="n">subtrees</span><span class="o">(</span><span class="n">child</span><span class="o">)</span> <span class="o">!</span> <span class="nc">Insert</span><span class="o">(</span><span class="n">requester</span><span class="o">,</span> <span class="n">id</span><span class="o">,</span> <span class="n">elemToInsert</span><span class="o">)</span>
        <span class="o">}</span>
        <span class="k">else</span> <span class="o">{</span>
          <span class="n">subtrees</span> <span class="o">+=</span> <span class="o">(</span><span class="n">child</span> <span class="o">-&gt;</span> <span class="n">context</span><span class="o">.</span><span class="n">actorOf</span><span class="o">(</span><span class="nc">BinaryTreeNode</span><span class="o">.</span><span class="n">props</span><span class="o">(</span><span class="n">elemToInsert</span><span class="o">,</span> <span class="kc">false</span><span class="o">)))</span>
          <span class="n">requester</span> <span class="o">!</span> <span class="nc">OperationFinished</span><span class="o">(</span><span class="n">id</span><span class="o">)</span>
        <span class="o">}</span>
      <span class="o">}</span>
      <span class="k">else</span> <span class="o">{</span>
        <span class="n">requester</span> <span class="o">!</span> <span class="nc">OperationFinished</span><span class="o">(</span><span class="n">id</span><span class="o">)</span>
      <span class="o">}</span>
<span class="o">}</span>
</pre></div>


<h3>Remove Messages</h3>
<p>Remove messages are more difficult to deal with.  We will not be implementing the same removal procedure as described in <em>Binary Search Tree Basics</em>.  Unlike node search and insertion, node removal results in a tree restructuring.  This is problematic in aysnchronous applications.  For example, what if  a removal causes a tree restructuring that occurs while other messages are still being processed and coming in? Synchronization is required for tree restructuring which does not fit within the actor model.  For this reason, we will handle removal by giving each node a <code>removed</code> flag that indicates if the node has been removed.  This way, removal occurs by simply setting the <code>removed</code> flag to <code>true</code>.</p>
<div class="highlight"><pre><span class="k">case</span> <span class="nc">Remove</span><span class="o">(</span><span class="n">requester</span><span class="o">,</span> <span class="n">id</span><span class="o">,</span> <span class="n">elemToRemove</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="o">{</span>

      <span class="k">if</span> <span class="o">(</span><span class="n">elem</span> <span class="o">!=</span> <span class="n">elemToRemove</span> <span class="o">||</span> <span class="o">(</span><span class="n">elem</span><span class="o">==</span><span class="n">elemToRemove</span> <span class="o">&amp;&amp;</span> <span class="n">removed</span><span class="o">))</span> <span class="o">{</span>

        <span class="k">val</span> <span class="n">child</span> <span class="k">=</span> <span class="n">childToVisit</span><span class="o">(</span><span class="n">elemToRemove</span><span class="o">)</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">subtrees</span><span class="o">.</span><span class="n">contains</span><span class="o">(</span><span class="n">child</span><span class="o">))</span> <span class="o">{</span>
          <span class="n">subtrees</span><span class="o">(</span><span class="n">child</span><span class="o">)</span> <span class="o">!</span> <span class="nc">Remove</span><span class="o">(</span><span class="n">requester</span><span class="o">,</span> <span class="n">id</span><span class="o">,</span> <span class="n">elemToRemove</span><span class="o">)</span>
        <span class="o">}</span>
        <span class="k">else</span> <span class="o">{</span>
          <span class="n">requester</span> <span class="o">!</span> <span class="nc">OperationFinished</span><span class="o">(</span><span class="n">id</span><span class="o">)</span>
        <span class="o">}</span>
      <span class="o">}</span>
      <span class="k">else</span> <span class="o">{</span>
        <span class="n">removed</span> <span class="k">=</span> <span class="kc">true</span>
        <span class="n">requester</span> <span class="o">!</span> <span class="nc">OperationFinished</span><span class="o">(</span><span class="n">id</span><span class="o">)</span>
      <span class="o">}</span>
<span class="o">}</span>
</pre></div>


<p>This makes removal asynchronous and much simpler however it also means that we will be accumulating nodes that have been removed which could become problematic in terms of memory.  We will deal with this by introducing a new type of message called <code>GC</code> (for <em>Garbage Collection</em>) that the main <code>BinaryTreeSet</code> actor can receive.  When this message is received, all of the nodes in the tree that haven't been removed (i.e. where <code>removed = false</code>) are copied and inserted into a new tree (with a new root node) which results in a new tree where the nodes that have been removed are <em>actually</em> removed.  Also, when the copy is completed, all of the actors in the old tree are stopped.  There will also be a <code>CopyTo</code> message which holds the root node of the new tree as a field.  This message is recursively sent to each node in the old tree and if its <code>removed</code> flag is <code>false</code> then it is inserted into the new tree. One more thing we must deal with is what to do with messages that come in while garbage collection is taking place.  We will deal with this by enqueuing these messages and then begin processing them once garbage collection has completed.</p>
<p>So once the <code>GC</code> message is received by the <code>BinaryTreeSet</code> actor, it enters into a new context where it waits for the new tree to be copied while also enqueuing other messages that are received during this time.</p>
<div class="highlight"><pre><span class="k">case</span> <span class="nc">GC</span> <span class="k">=&gt;</span> <span class="o">{</span>
      <span class="k">val</span> <span class="n">newRoot</span> <span class="k">=</span> <span class="n">createRoot</span>
      <span class="n">root</span> <span class="o">!</span> <span class="nc">CopyTo</span><span class="o">(</span><span class="n">newRoot</span><span class="o">)</span>
      <span class="n">context</span><span class="o">.</span><span class="n">become</span><span class="o">(</span><span class="n">garbageCollecting</span><span class="o">(</span><span class="n">newRoot</span><span class="o">))</span>
    <span class="o">}</span>
</pre></div>


<div class="highlight"><pre>  <span class="k">def</span> <span class="n">garbageCollecting</span><span class="o">(</span><span class="n">newRoot</span><span class="k">:</span> <span class="kt">ActorRef</span><span class="o">)</span><span class="k">:</span> <span class="kt">Receive</span> <span class="o">=</span> <span class="o">{</span>

    <span class="k">case</span> <span class="n">operation</span><span class="k">:</span> <span class="kt">Operation</span> <span class="o">=&gt;</span> <span class="n">pendingQueue</span><span class="o">.</span><span class="n">enqueue</span><span class="o">(</span><span class="n">operation</span><span class="o">)</span>

    <span class="k">case</span> <span class="nc">CopyFinished</span> <span class="k">=&gt;</span> <span class="o">{</span>
      <span class="n">root</span> <span class="o">!</span> <span class="nc">PoisonPill</span>
      <span class="k">val</span> <span class="n">newRoot</span> <span class="k">=</span> <span class="n">createRoot</span>
      <span class="n">root</span> <span class="k">=</span> <span class="n">newRoot</span>

      <span class="n">pendingQueue</span><span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="n">root</span> <span class="o">!</span> <span class="k">_</span><span class="o">)</span>
      <span class="n">pendingQueue</span> <span class="k">=</span> <span class="nc">Queue</span><span class="o">.</span><span class="n">empty</span>

      <span class="n">context</span><span class="o">.</span><span class="n">become</span><span class="o">(</span><span class="n">normal</span><span class="o">)</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>


<p>Then once it receives the <code>CopyFinished</code> message, it executes all of the messages that are in the queue and  returns to its normal context.  For the <code>BinaryTreeNode</code> actors, the <code>CopyTo</code> message is handled as follows.</p>
<div class="highlight"><pre><span class="k">case</span> <span class="nc">CopyTo</span><span class="o">(</span><span class="n">newRoot</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="o">{</span>
      <span class="k">if</span> <span class="o">(!</span><span class="n">removed</span><span class="o">){</span>
        <span class="n">newRoot</span> <span class="o">!</span> <span class="nc">Insert</span><span class="o">(</span><span class="n">self</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">elem</span><span class="o">)</span>
      <span class="o">}</span>

      <span class="n">subtrees</span><span class="o">.</span><span class="n">values</span> <span class="n">foreach</span> <span class="o">(</span><span class="k">_</span> <span class="o">!</span> <span class="nc">CopyTo</span><span class="o">(</span><span class="n">newRoot</span><span class="o">))</span>

      <span class="k">if</span> <span class="o">(</span><span class="n">removed</span> <span class="o">&amp;&amp;</span> <span class="n">subtrees</span><span class="o">.</span><span class="n">isEmpty</span><span class="o">){</span>
        <span class="n">sender</span> <span class="o">!</span> <span class="nc">CopyFinished</span>
      <span class="o">}</span>
      <span class="k">else</span><span class="o">{</span>
        <span class="n">context</span><span class="o">.</span><span class="n">become</span><span class="o">(</span><span class="n">copying</span><span class="o">(</span><span class="n">subtrees</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">toSet</span><span class="o">,</span> <span class="n">insertConfirmed</span> <span class="k">=</span> <span class="n">removed</span><span class="o">,</span> <span class="n">sender</span><span class="o">))</span>
      <span class="o">}</span>
<span class="o">}</span>
</pre></div>


<p>i.e. if the node has not been removed, insert it into the new tree.  Alternatively, if it has been removed and it is an external node, then there is nothing left to copy and the <code>CopyFinished</code> message is sent back to the sending node.  Once a node sends the <code>CopyTo</code> message to its children, it enters a <code>copying</code> context in which it waits for each of its children to return a <code>CopyFinished</code> message, at which point the node itself returns a <code>CopyFinished</code> message to its parent until eventually the <code>BinaryTreeSet</code> actor (the actor that initially sent the <code>CopyTo</code> message) receives a <code>CopyFinished</code> message and we know that all nodes have been copied. The <code>copying</code> context is shown below.</p>
<div class="highlight"><pre><span class="k">def</span> <span class="n">copying</span><span class="o">(</span><span class="n">expected</span><span class="k">:</span> <span class="kt">Set</span><span class="o">[</span><span class="kt">ActorRef</span><span class="o">],</span> <span class="n">insertConfirmed</span><span class="k">:</span> <span class="kt">Boolean</span><span class="o">,</span> <span class="n">originator</span><span class="k">:</span> <span class="kt">ActorRef</span><span class="o">)</span><span class="k">:</span> <span class="kt">Receive</span> <span class="o">=</span> <span class="o">{</span>
    <span class="k">case</span> <span class="nc">OperationFinished</span><span class="o">(</span><span class="k">_</span><span class="o">)</span> <span class="k">=&gt;</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">expected</span><span class="o">.</span><span class="n">isEmpty</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">originator</span> <span class="o">!</span> <span class="nc">CopyFinished</span>
        <span class="n">context</span><span class="o">.</span><span class="n">become</span><span class="o">(</span><span class="n">normal</span><span class="o">)</span>
      <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="n">context</span><span class="o">.</span><span class="n">become</span><span class="o">(</span><span class="n">copying</span><span class="o">(</span><span class="n">expected</span><span class="o">,</span> <span class="n">insertConfirmed</span> <span class="k">=</span> <span class="kc">true</span><span class="o">,</span> <span class="n">originator</span><span class="o">))</span>
      <span class="o">}</span>
    <span class="k">case</span> <span class="nc">CopyFinished</span> <span class="k">=&gt;</span>
      <span class="k">val</span> <span class="n">newExpected</span> <span class="k">=</span> <span class="n">expected</span> <span class="o">-</span> <span class="n">sender</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">newExpected</span><span class="o">.</span><span class="n">isEmpty</span> <span class="o">&amp;&amp;</span> <span class="n">insertConfirmed</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">originator</span> <span class="o">!</span> <span class="nc">CopyFinished</span>
        <span class="n">context</span><span class="o">.</span><span class="n">become</span><span class="o">(</span><span class="n">normal</span><span class="o">)</span>
      <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="n">context</span><span class="o">.</span><span class="n">become</span><span class="o">(</span><span class="n">copying</span><span class="o">(</span><span class="n">newExpected</span><span class="o">,</span> <span class="n">insertConfirmed</span><span class="o">,</span> <span class="n">originator</span><span class="o">))</span>
      <span class="o">}</span>
<span class="o">}</span>
</pre></div>


<p>And that is the basic functionality of the distributed binary search tree.  The full code is available on <a href="https://github.com/alexminnaar/ActorBinaryTree">this github repo</a>.  Hopefully this blog post has shed some light on the Akka actor model and how it can be used to build concurrent, distributed applications like this one.</p>
<h2>References</h2>
<ul>
<li><a href="http://akka.io/">The Akka Homepage</a></li>
<li><a href="https://www.coursera.org/course/reactive">Principles of Reactive Programming Coursera Course</a></li>
<li><a href="https://github.com/alexminnaar/ActorBinaryTree">GitHub repository</a> for the code used in this post.</li>
</ul>
                    </article>
                </div>
            </aside><!-- /#featured -->
            
        
        

    
            <aside id="featured">
                <div class="body">
                    <article>
                        <h1 class="entry-title"><a href="/introduction-to-the-multithreading-problem-and-the-akka-actor-solution.html">Introduction to the Multithreading Problem and the Akka Actor Solution</a></h1>
<div class="post-info">
	<ul>
        <li class="vcard author">
                 by&nbsp;<a class="url fn" href="/author/alex-minnaar.html">Alex Minnaar</a>
        </li>
        <li class="published" title="2014-12-27T00:00:00+01:00">
          on&nbsp;Sat 27 December 2014
        </li>

	</ul>
<p>Category: <a href="/tag/software-engineering.html">   Software Engineering</a></p>
</div><!-- /.post-info --><h2>The Multithreading Problem</h2>
<p>Nowadays, computers have multiple execution cores meaning that they can execute multiple tasks at the same time rather than sequentially.  Obviously this makes things much faster but it also presents some new problems.  The term <em>multithreading</em> refers to the process in which multiple threads execute code in the same program simultaneously.  The inherent problem with multithreading lies in the fact that although each thread acts independently, their memory is shared.  Therefore, it is possible for threads to change shared memory values without other threads knowing which can create problems.  Let's use a bank account as an example.  Consider the following code that implements a bank account with <code>deposit</code> and <code>withdraw</code> methods.</p>
<div class="highlight"><pre><span class="k">class</span> <span class="nc">BankAccount</span><span class="o">{</span>

    <span class="k">private</span> <span class="k">var</span> <span class="n">balance</span> <span class="k">=</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="n">deposit</span><span class="o">(</span><span class="n">amount</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span><span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span> 
        <span class="k">if</span> <span class="o">(</span><span class="n">amount</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="n">balance</span> <span class="k">=</span> <span class="n">balance</span> <span class="o">+</span> <span class="n">amount</span>

    <span class="k">def</span> <span class="n">withdraw</span><span class="o">(</span><span class="n">amount</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span><span class="k">:</span> <span class="kt">Int</span> <span class="o">=</span>
        <span class="k">if</span> <span class="o">(</span><span class="mi">0</span> <span class="o">&lt;</span> <span class="n">amount</span> <span class="o">&amp;&amp;</span> <span class="n">amount</span> <span class="o">&lt;=</span> <span class="n">balance</span><span class="o">){</span>
            <span class="n">balance</span> <span class="k">=</span> <span class="n">balance</span> <span class="o">-</span> <span class="n">amount</span>
            <span class="n">balance</span>
        <span class="o">}</span> <span class="k">else</span> <span class="k">throw</span> <span class="k">new</span> <span class="nc">Error</span><span class="o">(</span><span class="s">&quot;insufficient funds&quot;</span><span class="o">)</span>

<span class="o">}</span>
</pre></div>


<p>Here is a scenario where multithreading can cause problems.  Let's say that <code>balance</code>=40 dollars and <em>thread A</em> would like to withdraw 30 dollars. This satisfies both conditions in the <em>if</em> statement so <em>thread A</em> enters the code block where the 30 dollars is subtracted from the balance.  However, before <em>thread A</em> changes the balance, a second thread, <em>thread B</em>, wants to withdraw 20 dollars.  Since <em>thread A</em> has not yet changed the balance, <em>thread B</em> also satisfies the <em>if</em> statement and enters the code block where the balance can be changed.  So <em>thread A</em> subtracts $30 from the balance and then <em>thread B</em> subtracts 20 dollars from the balance leaving us with a balance of -10 dollars. Clearly, this is a problem!</p>
<p>Hopefully it is clear that the problem comes from the fact that the shared <em>balance</em> variable can be changed by any thread at any time so no thread can really be sure what value it holds.  One solution is for a thread to be able to reserve the memory values that it will be using so that no other thread can change them.  This is called <em>locking</em>.</p>
<h3>Using Locks (Synchronous)</h3>
<p>As stated previously, locking tries to solve the multithreading problem by <em>protecting</em> the shared memory value (in this case <code>balance</code>). Scala does this with <em>synchronization</em>.  Consider the same code as above but now each method definition is wrapped in <code>this.synchronized</code>.</p>
<div class="highlight"><pre><span class="k">class</span> <span class="nc">BankAccount</span><span class="o">{</span>

    <span class="k">private</span> <span class="k">var</span> <span class="n">balance</span> <span class="k">=</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="n">deposit</span><span class="o">(</span><span class="n">amount</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span><span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="n">synchronized</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">amount</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="n">balance</span> <span class="k">=</span> <span class="n">balance</span> <span class="o">+</span> <span class="n">amount</span>
    <span class="o">}</span>

    <span class="k">def</span> <span class="n">withdraw</span><span class="o">(</span><span class="n">amount</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span><span class="k">:</span> <span class="kt">Int</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="n">synchronized</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="mi">0</span> <span class="o">&lt;</span> <span class="n">amount</span> <span class="o">&amp;&amp;</span> <span class="n">amount</span> <span class="o">&lt;=</span> <span class="n">balance</span><span class="o">){</span>
            <span class="n">balance</span> <span class="k">=</span> <span class="n">balance</span> <span class="o">-</span> <span class="n">amount</span>
            <span class="n">balance</span>
        <span class="o">}</span> <span class="k">else</span> <span class="k">throw</span> <span class="k">new</span> <span class="nc">Error</span><span class="o">(</span><span class="s">&quot;insufficient funds&quot;</span><span class="o">)</span>
   <span class="o">}</span>

<span class="o">}</span>
</pre></div>


<p>Now <code>deposit</code> and <code>withdraw</code> each exit as one atomic unit meaning that only one thread can access them at a time (all others are blocked and must wait until the blocking thread is finished).  Now that all methods that can change <code>balance</code> are synchronized, conflicts such as the ones described above can no longer occur.  Unfortunately, the problem still is not completely solved because synchronization produces a few new problems.  For example, consider another <code>BankAccount</code> method called <code>transfer</code> which withdraws money from one account and deposits it into another with the following synchronized code.</p>
<div class="highlight"><pre><span class="k">def</span> <span class="n">transfer</span><span class="o">(</span><span class="n">from</span><span class="k">:</span> <span class="kt">BankAccount</span><span class="o">,</span> <span class="n">to</span><span class="k">:</span> <span class="kt">BankAccount</span><span class="o">,</span> <span class="n">amount</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span><span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span> <span class="o">{</span>
    <span class="n">from</span><span class="o">.</span><span class="n">synchronized</span> <span class="o">{</span>
        <span class="n">to</span><span class="o">.</span><span class="n">synchronized</span> <span class="o">{</span>
            <span class="n">from</span><span class="o">.</span><span class="n">withdraw</span><span class="o">(</span><span class="n">amount</span><span class="o">)</span>
            <span class="n">to</span><span class="o">.</span><span class="n">deposit</span><span class="o">(</span><span class="n">amount</span><span class="o">)</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>


<p>The withdrawal and deposit steps must be synchronized so that no thread can access the balance between withdrawal and deposit (at this point the amount transfered would not be anywhere).  The problem occurs when <em>thread A</em> wants to transfer money from <em>account A</em> to <em>account B</em> at the same time that <em>thread B</em> wants to transfer money from <em>account B</em> to <em>account A</em>.  When this happens <em>thread A</em> would lock <em>account A</em> and <em>thread B</em> would lock <em>account B</em> and each thread would wait for the other to release the lock which would take forever!  This is not good and it is called a <em>dead-lock</em> which is a common problem with synchronization.  There are ways of dealing with <em>dead-locks</em> but they are complicated and can make your code difficult to read.  In addition, stopping and starting threads when they become blocked turns out to be very bad for CPU utilization which will make your code run slower.  It would be much better if we could deal with this multithreading problem in such a way that we do not have to use any kind of blocking.  This is what the Akka actor model does.</p>
<h3>Using Actors (Asynchronous)</h3>
<p>Akka actors are fully encapsulated entities.  Changes to their internal state can only be done through passing known messages.  Message passing between actors is one-way and completely asynchronous (i.e. unblocking) so when an actor sends a message it does not have to wait for a reply, it can continue performing other tasks.  If multiple messages are sent to a single actor, it will process them sequentially in a queue (so internally an actor is single-threaded).  If a received message changes an actor's internal state, the change is reflected immediately after the message has been processed.  Therefore, processing one message is the atomic unit of execution (it can never be interrupted).</p>
<p>In terms of our bank account example, let's create a <code>BankAccount</code> actor that can receive <code>Deposit</code> and <code>Withdraw</code> messages.  In Scala, we create an actor by extending the <code>Actor</code> trait and implementing its <code>receive</code> method.  We must also define the messages that it can send and recieve in the actor's companion object.  The following is an actor-based <code>BankAccount</code> implementation.</p>
<div class="highlight"><pre><span class="k">object</span> <span class="nc">BankAccount</span> <span class="o">{</span>

  <span class="k">case</span> <span class="k">class</span> <span class="nc">Deposit</span><span class="o">(</span><span class="n">amount</span><span class="k">:</span> <span class="kt">BigInt</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">require</span><span class="o">(</span><span class="n">amount</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span>
  <span class="o">}</span>

  <span class="k">case</span> <span class="k">class</span> <span class="nc">Withdraw</span><span class="o">(</span><span class="n">amount</span><span class="k">:</span> <span class="kt">BigInt</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">require</span><span class="o">(</span><span class="n">amount</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span>
  <span class="o">}</span>

  <span class="k">case</span> <span class="k">object</span> <span class="nc">Done</span>

  <span class="k">case</span> <span class="k">object</span> <span class="nc">Failed</span>

<span class="o">}</span>

<span class="c1">//Actor that receives messages to perform actions of a bank account</span>
<span class="k">class</span> <span class="nc">BankAccount</span> <span class="k">extends</span> <span class="nc">Actor</span> <span class="o">{</span>

  <span class="k">import</span> <span class="nn">BankAccount._</span>

  <span class="k">var</span> <span class="n">balance</span> <span class="k">=</span> <span class="nc">BigInt</span><span class="o">(</span><span class="mi">0</span><span class="o">)</span>

  <span class="k">def</span> <span class="n">receive</span> <span class="k">=</span> <span class="nc">LoggingReceive</span> <span class="o">{</span>
    <span class="c1">//Deposit messages add amount to balance state</span>
    <span class="k">case</span> <span class="nc">Deposit</span><span class="o">(</span><span class="n">amount</span><span class="o">)</span> <span class="k">=&gt;</span>
      <span class="n">balance</span> <span class="o">+=</span> <span class="n">amount</span>
      <span class="n">sender</span> <span class="o">!</span> <span class="nc">Done</span>

    <span class="c1">//Withdraw messages subtract amount from balance state</span>
    <span class="k">case</span> <span class="nc">Withdraw</span><span class="o">(</span><span class="n">amount</span><span class="o">)</span> <span class="k">if</span> <span class="n">amount</span> <span class="o">&lt;=</span> <span class="n">balance</span> <span class="k">=&gt;</span>
      <span class="n">balance</span> <span class="o">-=</span> <span class="n">amount</span>
      <span class="n">sender</span> <span class="o">!</span> <span class="nc">Done</span>

    <span class="c1">//Any other message would return a failure to the sender</span>
    <span class="k">case</span> <span class="k">_</span> <span class="k">=&gt;</span> <span class="n">sender</span> <span class="o">!</span> <span class="nc">Failed</span>
  <span class="o">}</span>

<span class="o">}</span>
</pre></div>


<p>In the <code>BankAccount</code> companion object four messages are defined <code>Deposit</code>, <code>Withdraw</code>, <code>Done</code>, and <code>Failed</code>.  In the <code>receive</code> method in the <code>BankAccount</code> class defines how to change the <code>balance</code> variable when either the <code>Deposit</code> or the <code>Withdraw</code> method is received.  Once this is finished, a <code>Done</code> message is passed back to the actor that sent it via the <code>sender</code> variable (an actor's reference is always tied to the message it sends).  If any other message is received, then a <code>Failed</code> message is sent back to the sending actor.</p>
<p>But we also want to use an actor to transfer money between accounts.  You may remember that this had the potential to produce a <em>dead-lock</em> when done synchronously. We can avoid this using actors because now blocking is replaced with enqueuing messages.  Let's call this actor <code>WireTransfer</code>.  This actor can receive a <code>Transfer</code> message which contains three fields - a reference to the sending <code>BankAccount</code> actor, a reference to the receiving <code>BankAccount</code> actor, and the amount to be transferred.  When <code>WireTransfer</code> receives this message, it sends a <code>Withdraw</code> message (defined within the <code>BankAccount</code> companion object) to the sending actor, awaits a successful <code>Done</code> response, then sends a <code>Deposit</code> message to the recieving actor.  The following code implements the <code>WireTransfer</code> actor.</p>
<div class="highlight"><pre><span class="k">object</span> <span class="nc">WireTransfer</span> <span class="o">{</span>

  <span class="k">case</span> <span class="k">class</span> <span class="nc">Transfer</span><span class="o">(</span><span class="n">from</span><span class="k">:</span> <span class="kt">ActorRef</span><span class="o">,</span> <span class="n">to</span><span class="k">:</span> <span class="kt">ActorRef</span><span class="o">,</span> <span class="n">amount</span><span class="k">:</span> <span class="kt">BigInt</span><span class="o">)</span>

  <span class="k">case</span> <span class="k">object</span> <span class="nc">Done</span>

  <span class="k">case</span> <span class="k">object</span> <span class="nc">Failed</span>

<span class="o">}</span>

<span class="c1">//actor implementing the actions of a wire transfer between two bank account actors</span>
<span class="k">class</span> <span class="nc">WireTransfer</span> <span class="k">extends</span> <span class="nc">Actor</span> <span class="o">{</span>

  <span class="k">import</span> <span class="nn">WireTransfer._</span>

  <span class="k">def</span> <span class="n">receive</span> <span class="k">=</span> <span class="nc">LoggingReceive</span> <span class="o">{</span>
    <span class="c1">//If Transfer message is received, send withdraw message to &#39;from&#39; and wait for reply</span>
    <span class="k">case</span> <span class="nc">Transfer</span><span class="o">(</span><span class="n">from</span><span class="o">,</span> <span class="n">to</span><span class="o">,</span> <span class="n">amount</span><span class="o">)</span> <span class="k">=&gt;</span>
      <span class="n">from</span> <span class="o">!</span> <span class="nc">BankAccount</span><span class="o">.</span><span class="nc">Withdraw</span><span class="o">(</span><span class="n">amount</span><span class="o">)</span>
      <span class="n">context</span><span class="o">.</span><span class="n">become</span><span class="o">(</span><span class="n">awaitFrom</span><span class="o">(</span><span class="n">to</span><span class="o">,</span> <span class="n">amount</span><span class="o">,</span> <span class="n">sender</span><span class="o">))</span>
  <span class="o">}</span>

  <span class="c1">//If Withdraw was successful, send deposit to other bank account actor, or else give them a failure message</span>
  <span class="k">def</span> <span class="n">awaitFrom</span><span class="o">(</span><span class="n">to</span><span class="k">:</span> <span class="kt">ActorRef</span><span class="o">,</span> <span class="n">amount</span><span class="k">:</span> <span class="kt">BigInt</span><span class="o">,</span> <span class="n">customer</span><span class="k">:</span> <span class="kt">ActorRef</span><span class="o">)</span><span class="k">:</span> <span class="kt">Receive</span> <span class="o">=</span> <span class="nc">LoggingReceive</span> <span class="o">{</span>
    <span class="k">case</span> <span class="nc">BankAccount</span><span class="o">.</span><span class="nc">Done</span> <span class="k">=&gt;</span>
      <span class="n">to</span> <span class="o">!</span> <span class="nc">BankAccount</span><span class="o">.</span><span class="nc">Deposit</span><span class="o">(</span><span class="n">amount</span><span class="o">)</span>
      <span class="n">context</span><span class="o">.</span><span class="n">become</span><span class="o">(</span><span class="n">awaitTo</span><span class="o">(</span><span class="n">customer</span><span class="o">))</span>
    <span class="k">case</span> <span class="nc">BankAccount</span><span class="o">.</span><span class="nc">Failed</span> <span class="k">=&gt;</span>
      <span class="n">customer</span> <span class="o">!</span> <span class="nc">Failed</span>
      <span class="n">context</span><span class="o">.</span><span class="n">stop</span><span class="o">(</span><span class="n">self</span><span class="o">)</span>
  <span class="o">}</span>

  <span class="c1">//If deposit was successful, send &#39;Done&#39; to original actor that sent Transfer message</span>
  <span class="k">def</span> <span class="n">awaitTo</span><span class="o">(</span><span class="n">customer</span><span class="k">:</span> <span class="kt">ActorRef</span><span class="o">)</span><span class="k">:</span> <span class="kt">Receive</span> <span class="o">=</span> <span class="nc">LoggingReceive</span> <span class="o">{</span>
    <span class="k">case</span> <span class="nc">BankAccount</span><span class="o">.</span><span class="nc">Done</span> <span class="k">=&gt;</span>
      <span class="n">customer</span> <span class="o">!</span> <span class="nc">Done</span>
      <span class="n">context</span><span class="o">.</span><span class="n">stop</span><span class="o">(</span><span class="n">self</span><span class="o">)</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>


<p>When the actor first receives the <code>Transfer</code> message, it sends a <code>Withdraw</code> message to the <code>BankAccount</code> actor referenced in the <code>from</code> field of the message.  Then the actor must wait until a <code>Done</code> message is received (it does this with the <code>context.become()</code> method) at which point it sends a <code>Deposit</code> message to the other <code>BankAccount</code> actor.</p>
<p>We can also test this transfer process by creating a new actor that creates two <code>BankAccount</code> actors and a <code>WireTransfer</code> actor and then sends a <code>Transfer</code> message to the <code>WireTransfer</code> actor which references both of the <code>BankAccount</code> actors.  But before the <code>Transfer</code> message is sent, the actor must deposit some money in the first <code>BankAccount</code> actor so that there is some money available to transfer.  Let's call this actor <code>TransferMain</code> and here is its implementation.</p>
<div class="highlight"><pre><span class="k">class</span> <span class="nc">TransferMain</span> <span class="k">extends</span> <span class="nc">Actor</span> <span class="o">{</span>

  <span class="c1">//First create two BankAccount actors</span>
  <span class="k">val</span> <span class="n">accountA</span> <span class="k">=</span> <span class="n">context</span><span class="o">.</span><span class="n">actorOf</span><span class="o">(</span><span class="nc">Props</span><span class="o">[</span><span class="kt">BankAccount</span><span class="o">],</span> <span class="s">&quot;accountA&quot;</span><span class="o">)</span>
  <span class="k">val</span> <span class="n">accountB</span> <span class="k">=</span> <span class="n">context</span><span class="o">.</span><span class="n">actorOf</span><span class="o">(</span><span class="nc">Props</span><span class="o">[</span><span class="kt">BankAccount</span><span class="o">],</span> <span class="s">&quot;accountB&quot;</span><span class="o">)</span>

  <span class="c1">//send a deposit message to accountA</span>
  <span class="n">accountA</span> <span class="o">!</span> <span class="nc">BankAccount</span><span class="o">.</span><span class="nc">Deposit</span><span class="o">(</span><span class="mi">100</span><span class="o">)</span>

  <span class="c1">//If a &#39;Done&#39; message is received back, call a transfer function</span>
  <span class="k">def</span> <span class="n">receive</span> <span class="k">=</span> <span class="nc">LoggingReceive</span> <span class="o">{</span>
    <span class="k">case</span> <span class="nc">BankAccount</span><span class="o">.</span><span class="nc">Done</span> <span class="k">=&gt;</span> <span class="n">transfer</span><span class="o">(</span><span class="mi">70</span><span class="o">)</span>
  <span class="o">}</span>

  <span class="c1">//transfer function creates a transacton actor and sends a &#39;Transfer&#39; message to it between</span>
  <span class="c1">//accountA and accountB for the specified amount.</span>
  <span class="k">def</span> <span class="n">transfer</span><span class="o">(</span><span class="n">amount</span><span class="k">:</span> <span class="kt">BigInt</span><span class="o">)</span><span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span> <span class="o">{</span>

    <span class="k">val</span> <span class="n">transaction</span> <span class="k">=</span> <span class="n">context</span><span class="o">.</span><span class="n">actorOf</span><span class="o">(</span><span class="nc">Props</span><span class="o">[</span><span class="kt">WireTransfer</span><span class="o">],</span> <span class="s">&quot;transfer&quot;</span><span class="o">)</span>

    <span class="n">transaction</span> <span class="o">!</span> <span class="nc">WireTransfer</span><span class="o">.</span><span class="nc">Transfer</span><span class="o">(</span><span class="n">accountA</span><span class="o">,</span> <span class="n">accountB</span><span class="o">,</span> <span class="n">amount</span><span class="o">)</span>

    <span class="n">context</span><span class="o">.</span><span class="n">become</span><span class="o">(</span><span class="nc">LoggingReceive</span> <span class="o">{</span>
      <span class="k">case</span> <span class="nc">WireTransfer</span><span class="o">.</span><span class="nc">Done</span> <span class="k">=&gt;</span>
        <span class="n">println</span><span class="o">(</span><span class="s">&quot;successs&quot;</span><span class="o">)</span>
        <span class="n">context</span><span class="o">.</span><span class="n">stop</span><span class="o">(</span><span class="n">self</span><span class="o">)</span>
      <span class="k">case</span> <span class="nc">WireTransfer</span><span class="o">.</span><span class="nc">Failed</span> <span class="k">=&gt;</span>
        <span class="n">println</span><span class="o">(</span><span class="s">&quot;failed&quot;</span><span class="o">)</span>
        <span class="n">context</span><span class="o">.</span><span class="n">stop</span><span class="o">(</span><span class="n">self</span><span class="o">)</span>
    <span class="o">})</span>

  <span class="o">}</span>
<span class="o">}</span>
</pre></div>


<p>As you can see from the above code, 100 dollars is deposted in <code>accountA</code> via the <code>Deposit</code> message.  Then, when the <code>Done</code> message is recieved, the <code>transfer</code> function is called with an argument of 70 dollars.  Inside the <code>transfer</code> function, a <code>WireTransfer</code> actor is created and a <code>Transfer</code> message is sent to it with the appropriate arguments.  It then waits for either a <code>Done</code> or <code>Failed</code> message in return.</p>
<p>Hopefully this blog post has shed some light on the multithreading problem and how the Akka actor model tries to solve it.</p>
<h2>References</h2>
<ul>
<li>This bank account example was taken from the <a href="https://www.coursera.org/course/reactive">Principles of Reactive Programming</a> Coursera course.</li>
<li>The full code snippets can be found <a href="https://github.com/alexminnaar/Scala_Code_Snippets/tree/master/src/main/scala/BankAccount">on github</a>.</li>
</ul>
                    </article>
                </div>
            </aside><!-- /#featured -->
            
        
        

    
            <aside id="featured">
                <div class="body">
                    <article>
                        <h1 class="entry-title"><a href="/scalaner-a-scala-wrapper-for-the-stanford-ner-tool-with-some-added-features.html">ScalaNER: A Scala Wrapper for the Stanford NER Tool with Some Added Features</a></h1>
<div class="post-info">
	<ul>
        <li class="vcard author">
                 by&nbsp;<a class="url fn" href="/author/alex-minnaar.html">Alex Minnaar</a>
        </li>
        <li class="published" title="2014-11-11T00:00:00+01:00">
          on&nbsp;Tue 11 November 2014
        </li>

	</ul>
<p>Category: <a href="/tag/nlp.html">   NLP</a><a href="/tag/software-engineering.html">   Software Engineering</a></p>
</div><!-- /.post-info --><p>The <a href="http://nlp.stanford.edu/software/CRF-NER.shtml">Stanford NER (named entity recognizer) tool</a> is a widely-used, general purpose named entity recognition tool that Stanford has made available as part of its CoreNLP Java library.  It performs named entity recognition via a CRF-based sequence model which has been known to give near state-of-the-art performance results which makes it a popular choice for open-source NER tools.</p>
<p>Having said that, I have used this tool in the past and I was left wanting more functionality.  From its <a href="http://nlp.stanford.edu/software/crf-faq.shtml">FAQ section</a>, you can see that most of its functionality (i.e. training and testing a NER model) is designed to be performed using the command line.  But what if you want to use a pre-trained NER model as part of a real-time text processing pipeline?  For example, you are processing a string of text and you want to apply your NER model to the text and then do something with the tokens corresponding to classified named entities.  There is no clear way to do this with the Stanford NER tool.</p>
<p>I have also found that the Stanford NER tool is lacking in its model validation functionality.  Just like any classification model, I want to be able to perform cross-validation tests on my training data so that I can be confident in its generalized performance.  Again, there is no clear way of doing this.  You can test your model on a test set and obtain the precision, recall and F1 values but unfortunately these values are just shown in standard output and there is no way to persist them.  Consequently, if you wanted to perform 50-fold cross-validation on your dataset you would have to visually read each of the 50 sets of performance metrics off the screen and then manually average them to get your desired result (or export standard output and parse it).  Obviously no one wants to do this.</p>
<p><a href="https://github.com/alexminnaar/ScalaNER">ScalaNER</a> attempts to solve these problems by offering the following additional functionality to the Stanford NER tool.</p>
<ul>
<li>Programmatically apply a pre-trained NER model to a string of text and output the labelled result.</li>
<li>Programmatically train an NER model.</li>
<li>Easy model validation.  Specifically cross-validation.</li>
</ul>
<h2>ScalaNER Demo</h2>
<p>The following code samples demonstrate this new functionality.  First of all, it should be noted that the training data sets must be in the same format that the Stanford NER tool accepts.  That is, each line must contain a tab-separated token/label pair.  Entity labels can be any string but non-entity labels must be "O".  For example, training data for a person name entity might look like</p>
<div class="highlight"><pre>The    O
US    O
president    O
is    O
Barrack    NAME
Obama    NAME
</pre></div>


<p>where named entities are labelled as "NAME" and non-entity tokens are labelled as "O".</p>
<h3>Train an NER Model</h3>
<p>First we will demonstrate how to train a NER model given a training dataset in the format explained above.  The code is very simple - in fact it is only one line.  It uses a Scala object called <code>NERModel</code>.  To train an NER model you simply call this object's <code>trainClassifier</code> method which takes two arguments, the location of the training data file (it must be a text file) and the filename and location where the the trained NER model will be saved.</p>
<div class="highlight"><pre><span class="nc">NERModel</span><span class="o">.</span><span class="n">trainClassifier</span><span class="o">(</span><span class="s">&quot;my/data/location.txt&quot;</span><span class="o">,</span> <span class="s">&quot;save/my/model/here.ser.gz&quot;</span><span class="o">)</span>
</pre></div>


<h3>Apply an NER Model</h3>
<p>Then once you have trained your NER model you will probably want to apply this model to some new text.  To do this we use the <code>ApplyModel</code> class which takes the location of the trained model as a constructor.  Once this class has been instantiated, we call its <code>runNER</code> method which takes a string as an input argument.  This input string is the text from which you want to extract the named entities.  The result is an indexed sequence of <code>LabeledToken</code> objects which contain a token field and a label field.  The token fields contain the tokens in the input string and the label fields contain the named entities that the tokens have been assigned to.</p>
<div class="highlight"><pre><span class="k">val</span> <span class="n">classifier</span><span class="k">=new</span> <span class="nc">ApplyModel</span><span class="o">(</span><span class="s">&quot;my/pretrained/model.ser.gz&quot;</span><span class="o">)</span>

<span class="k">val</span> <span class="n">results</span><span class="k">=</span><span class="n">classifier</span><span class="o">.</span><span class="n">runNER</span><span class="o">(</span><span class="s">&quot;Find named entities in this new sentence.&quot;</span><span class="o">)</span>
</pre></div>


<h3>Performing Cross-Validation on an NER Model</h3>
<p>To perform cross-validation we use the CrossValidation class which takes the number of folds and training data location as constructors.  Then we call the <code>runCrossValidation</code> method with an input parameter that is the location of the directory where the training and validation sets will be written.  The result is a vector whose elements correspond to the number of folds.  Each element is a map whose keys represent the unique entity types in that fold and values represent the precision, recall and F1-score of the corresponding entity type.</p>
<div class="highlight"><pre><span class="k">val</span> <span class="n">testInstance</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">CrossValidation</span><span class="o">(</span><span class="mi">5</span><span class="o">,</span> <span class="s">&quot;location/of/training/data.txt&quot;</span><span class="o">)</span>

<span class="k">val</span> <span class="n">xvalResults</span><span class="k">=</span><span class="n">classifier</span><span class="o">.</span><span class="n">runCrossValidation</span><span class="o">(</span><span class="s">&quot;directory/to/write/xvalidation/data/&quot;</span><span class="o">)</span>
</pre></div>


<p>Next let's look at a real-world example.</p>
<h2>Example: Identifying Protein Names</h2>
<p>Suppose that you wanted to train an NER model to identify protein named in bio-medical literature.  We will use the BioNLP dataset that has already been transformed into the correct Stanford NER format which can be found in the <a href="https://github.com/alexminnaar/ScalaNER/tree/master/data">ScalaNER github repo</a>.</p>
<p>First let's try training an NER model with this data and running it on a sample string of text to determine if it contains any protein names.</p>
<div class="highlight"><pre><span class="nc">NERModel</span><span class="o">.</span><span class="n">trainClassifier</span><span class="o">(</span><span class="s">&quot;data/bionlp.txt&quot;</span><span class="o">,</span> <span class="s">&quot;/bioNlpModel.ser.gz&quot;</span><span class="o">)</span>

<span class="k">val</span> <span class="n">classifier</span><span class="k">=new</span> <span class="nc">ApplyModel</span><span class="o">(</span><span class="s">&quot;/bioNlpModel.ser.gz&quot;</span><span class="o">)</span>

<span class="k">val</span> <span class="n">results</span><span class="k">=</span><span class="n">classifier</span><span class="o">.</span><span class="n">runNER</span><span class="o">(</span><span class="s">&quot;Leukotriene B4 stimulates c-fos and c-jun gene transcription and AP-1 binding activity in human monocytes.&quot;</span><span class="o">)</span>

<span class="n">println</span><span class="o">(</span><span class="n">results</span><span class="o">)</span>
</pre></div>


<p>Which gives the following output</p>
<p><code>Vector(LabeledToken(Leukotriene,O), LabeledToken(B4,O), LabeledToken(stimulates,O), LabeledToken(c-fos,protein), LabeledToken(and,O), LabeledToken(c-jun,protein), LabeledToken(gene,O), LabeledToken(transcription,O), LabeledToken(and,O), LabeledToken(AP-1,O), LabeledToken(binding,O), LabeledToken(activity,O), LabeledToken(in,O), LabeledToken(human,O), LabeledToken(monocytes,O), LabeledToken(.,O))</code></p>
<p>As you can see, the trained model assigns the correct <em>protein</em> label to the tokens "c-fos" and "c-jun" and all other tokens are assigned the <em>O</em> label indicating that they are not named entities.</p>
<p>Next, let's perform 5-fold cross-validation on the entire dataset to get a good idea of its generalized performance.  This can be done in the following code where we specify the folder "data/xval" to be location where the 5 training and validation sets will be written.</p>
<div class="highlight"><pre><span class="k">val</span> <span class="n">cv</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">CrossValidation</span><span class="o">(</span><span class="mi">5</span><span class="o">,</span> <span class="s">&quot;data/bionlp.txt&quot;</span><span class="o">)</span>

<span class="k">val</span> <span class="n">testResults</span> <span class="k">=</span> <span class="n">cv</span><span class="o">.</span><span class="n">runCrossValidation</span><span class="o">(</span><span class="s">&quot;data/xval&quot;</span><span class="o">)</span>

<span class="n">println</span><span class="o">(</span><span class="n">testResults</span><span class="o">)</span>
</pre></div>


<p>Which gives the following output</p>
<p><code>Vector(Map(protein -&gt; Performance(0.680461329715061,0.9862340216322517,0.8052990766760337), O -&gt; Performance(0.999634483838964,0.9878479836941098,0.9937062846316554)), Map(O -&gt; Performance(0.9991162403826159,0.9858425237240318,0.9924350003872866), protein -&gt; Performance(0.5766871165644172,0.9567430025445293,0.7196172248803828)), Map(O -&gt; Performance(0.9986442092089483,0.9858183409260546,0.9921898273472612), protein -&gt; Performance(0.6125175808720112,0.9436619718309859,0.7428571428571428)), Map(O -&gt; Performance(0.9994266652767643,0.9878419452887538,0.9936005389019872), protein -&gt; Performance(0.6638176638176638,0.9769392033542977,0.7905004240882104)), Map(O -&gt; Performance(0.9988831168831169,0.9877484974572354,0.9932846036624738), protein -&gt; Performance(0.6261755485893417,0.9489311163895487,0.7544853635505192)))</code></p>
<p>The above output shows the precision, recall and F1-scores for each entity type (in this case protein and O) and each of the 5 folds.  So the F1-scores associated with identifying <em>protein</em> named entities are 0.8052, 0.7196, 0.7428, 0.7905, and 0.7544 for an average F1-score of 0.7625.</p>
<h2>References</h2>
<ul>
<li><a href="http://nlp.stanford.edu/software/CRF-NER.shtml">Stanford Named Entity Recognizer</a></li>
<li><a href="https://github.com/alexminnaar/ScalaNER">ScalaNER Github Repo</a></li>
</ul>
                    </article>
                </div>
            </aside><!-- /#featured -->
            
        
        

    
            <aside id="featured">
                <div class="body">
                    <article>
                        <h1 class="entry-title"><a href="/online-latent-dirichlet-allocation-the-best-option-for-topic-modeling-with-large-data-sets.html">Online Latent Dirichlet Allocation - The Best Option for Topic Modeling with Large Data Sets</a></h1>
<div class="post-info">
	<ul>
        <li class="vcard author">
                 by&nbsp;<a class="url fn" href="/author/alex-minnaar.html">Alex Minnaar</a>
        </li>
        <li class="published" title="2014-10-14T00:00:00+02:00">
          on&nbsp;Tue 14 October 2014
        </li>

	</ul>
<p>Category: <a href="/tag/bayesian-inference.html">   Bayesian Inference</a><a href="/tag/nlp.html">   NLP</a></p>
</div><!-- /.post-info --><p>By now it has become very clear that Latent Dirichlet Allocation (LDA) has a variety of valuable, real-world use cases.  However, most real-world use cases involve large volumes of data which can be problematic for LDA.  This is because both of the traditional implementations of LDA (variational inference and collapsed Gibbs sampling) require the entire corpus (or some encoding of it) to be loaded into main memory.  Obviously, if you are working with a single machine and a data set that is sufficiently large, this can be infeasible.  One solution is to parallelize the algorithm and scale out until you have the required resources.  However, this presents an entire new set of problems - acquiring a cluster of machines, modifying your LDA code such that it can work in a MapReduce framework, etc.  A much better solution would be to segment your large data set into small batches and sequentially read each of these batches into main memory and update your LDA model as you go in an online fashion.  This way you are only keeping a small fraction of your large data set in main memory at any given time.  Furthermore, consider a scenario where your corpus is constantly growing such as an online discussion forum.  As your corpus grows you want to see how the topics are changing.  With traditional variational inference you would have to rerun the entire batch algorithm with the old data and the new data but it would be much more efficient to simply update your model with only the new data.  In their paper <a href="https://www.google.ca/url?sa=t&amp;rct=j&amp;q=&amp;esrc=s&amp;source=web&amp;cd=1&amp;cad=rja&amp;uact=8&amp;ved=0CDEQFjAA&amp;url=https%3A%2F%2Fwww.cs.princeton.edu%2F~blei%2Fpapers%2FHoffmanBleiBach2010b.pdf&amp;ei=b4bvU-2_K433yQSbh4LoCw&amp;usg=AFQjCNHLmU8Gk_P4usBj2QcGcaolw87w4w&amp;sig2=cbFKirN-0jWvPj-mCqRP_g&amp;bvm=bv.73231344,d.aWw">Online Learning for Latent Dirichlet Allocation</a>, Blei et al. present an algorithm for achieving this kind of functionality.  This blog post aims to give a summary of this paper and also show some results from my own Scala implementation.</p>
<h2>Variational Inference vs Stochastic Variational Inference</h2>
<p>Let's start off with a very general graphical model that includes observations, local hidden variables, and global hidden variables.</p>
<p><img alt="general graphical model" src="images/general_graphical_model.png" /> </p>
<p>In the above graphical model, there are <span class="math">\(N\)</span> observations <span class="math">\(x_{1:N}\)</span> and one local hidden variable for each observation <span class="math">\(z_{1:N}\)</span>.  There are also global hidden variables <span class="math">\(\beta\)</span> with a known prior <span class="math">\(\alpha\)</span>.  I will first compare variation inference with stochastic variational inference in the context of this graphical model because it can be generalized to a variety of different graphical models with local and global hidden variables e.g. the LDA model, Gaussian mixture models, hidden Markov models and many more.</p>
<p>The joint distribution of this graphical model is</p>
<p><span class="math">\(p(x,z,\beta | \alpha)=p(\beta | \alpha)\prod_{n=1}^Np(x_n,z_n | \beta)\)</span></p>
<p>Also, our assumption that <span class="math">\(\beta\)</span> are the global parameters and <span class="math">\(z_n\)</span> are the local parameters is formalized by the fact that the observation <span class="math">\(x_n\)</span> and the corresponding local variable <span class="math">\(z_n\)</span> are conditionally independent given the global variables <span class="math">\(\beta\)</span> i.e.</p>
<p><span class="math">\(p(x_n,z_n|x_{-n},z_{-n},\beta,\alpha)=p(x_n,z_n|\beta,\alpha)\)</span></p>
<p>Another assumption that we make in this model is that the conditional distributions of the hidden variables given the observations and other hidden variables (also called the complete conditionals) are in the exponential family which means they take the general form</p>
<p><span class="math">\(p(\beta | x,z,\alpha)=h(\beta)\exp(\eta_g (x,z,\alpha)^Tt(\beta)-a_g(\eta_g(x,z,\alpha)))\)</span></p>
<p><span class="math">\(p(z_{nj}|x_n,z_{n,-j},\beta)=h(z_{nj})\exp(\eta_l(x_n,z_{n,-j},\beta)^Tt(z_{nj})-\alpha_l(\eta_l(x_n,z_{n,-j},\beta)))\)</span></p>
<p>Where <span class="math">\(h(.)\)</span> is called the base measure, <span class="math">\(a(.)\)</span> is called the log-normalizer, <span class="math">\(\eta(.)\)</span> is called the natural parameter, and <span class="math">\(t(.)\)</span> is called the sufficient statistics.  Furthermore, we also assume that the prior distribution over <span class="math">\(\beta\)</span> is part of the exponential family.</p>
<p><span class="math">\(p(\beta)=h(\beta)\exp(\alpha^Tt(\beta)-a_g(\alpha))\)</span></p>
<p>The main goal is to compute the posterior distribution of the hidden variables given the observed variables</p>
<p>
<div class="math">$$p(\beta,z|x)=\frac{p(x,z,\beta)}{\int p(x,z,\beta)dz d \beta}$$</div>
</p>
<p>Unfortunately, the denominator <span class="math">\(\int p(x,z,\beta)dz d \beta\)</span> is intractable to compute so we must use approximate inference techniques such as variational inference.</p>
<h3>Variational Inference</h3>
<p>Variational inference turns the inference problem into an optimization problem.  A new distribution over the hidden variables <span class="math">\(q(z,\beta)\)</span> (called the variational distribution) is introduced.  This new distribution has properties such that it can be efficiently computed.  The variational distribution is a function of a set of free parameters that are optimized such that the variational distribution is as close as possible to the actual target posterior distribution where closeness is measured in terms of KL divergence.  Minimizing the KL divergence between the variational distribution and the target posterior is equivalent to maximizing the evidence lower bound (ELBO) (proof not shown here) which is</p>
<p>
<div class="math">$$\mathscr{L}(q)=E_q[\log p(x,z,\beta)]-E_q[\log q(z,\beta)]$$</div>
</p>
<p>As stated earlier, the variational distribution has the property that it can be efficiently computed.  This is done by making each hidden variable independent of each other.</p>
<p><span class="math">\(q(z,\beta)=q(\beta|\lambda)\prod_{n=1}^N \prod_{j=1}^J q(z_{nj}|\phi_{nj})\)</span></p>
<p>Furthermore, each hidden variable is governed by its own variational parameter so the variational parameters <span class="math">\(\lambda\)</span> governs the global variables <span class="math">\(\beta\)</span> and the variational parameters <span class="math">\(\phi_n\)</span> govern the local variables <span class="math">\(z_n\)</span>.  <span class="math">\(q(\beta | \lambda)\)</span> and <span class="math">\(q(z_{nj} | \phi_{nj})\)</span> take the same form as the complete conditionals <span class="math">\(p(\beta | x,z,\alpha)\)</span> and <span class="math">\(p(z_{nj}|x_n,z_{n,-j},\beta)\)</span>, but the natural parameters are now <span class="math">\(\lambda\)</span> and <span class="math">\(\phi_{nj}\)</span>, respectively to give</p>
<p><span class="math">\(q(\beta | \lambda)=h(\beta)\exp(\lambda^Tt(\beta)-a_g(\lambda))\)</span></p>
<p><span class="math">\(q(z_{nj}|\phi_{nj})=h(z_{nj})\exp(\phi_{nj}^Tt(z_{nj})-a_l(\phi_{nj}))\)</span></p>
<p>We maximize the ELBO objective function with a coordinate ascent procedure.  We find its gradient with respect to the global variational parameter <span class="math">\(\lambda\)</span> and find the value of <span class="math">\(\lambda\)</span> that sets the gradient to zero.  We do the same thing for the local parameters <span class="math">\(\phi_{n}\)</span>.  We iterate between these updates until we converge to the maximum of the ELBO.  The updates are given without proof, but the general procedure is to write the ELBO in terms of parameter of interest (either <span class="math">\(\lambda\)</span> or <span class="math">\(\phi_n\)</span>) then take the gradient and set it to zero.</p>
<p>
<div class="math">$$\lambda=E_q[\eta_g(x,z,\alpha)]$$</div>
</p>
<p>
<div class="math">$$\phi_{nj}=E_q[\eta_l(x_n,z_{n,-j},\beta)]$$</div>
</p>
<p>Therefore the updates of each variational parameter are equal to the expected value of the natural parameters of the complete conditionals.  The complete coordinate ascent algorithm is given below.</p>
<p><img alt="variational inference" src="images/variational_inference.png" /> </p>
<p>As you can see, in the local parameter update (steps 3 and 4), we have to iterate over every data point in the data set which is computationally expensive and (as we will see later) not necessary.</p>
<h3>Stochastic Variational Inference</h3>
<p>Stochastic variational inference uses a stochastic optimization technique to sequentially maximize the ELBO using unbiased samples from the data set.  Updates are performed with the following formula</p>
<p><span class="math">\(\lambda^{(t)}=\lambda^{(t-1)}+\rho_tb_t(\lambda^{(t-1)})\)</span></p>
<p>where <span class="math">\(b_t\)</span> is a noisy (but unbiased) gradient of the objective function obtained from a subsample of the data set.  If the step size <span class="math">\(\rho_t\)</span> satisfies the following constraints</p>
<p><span class="math">\(\sum \rho_t=\infty\)</span>,   <span class="math">\(\sum \rho_t^2 &lt; \infty\)</span></p>
<p>then it is guaranteed to converge to the global optimum <span class="math">\(\lambda^*\)</span> if the objective function is convex, or a local optima if it is not convex.  Now let's look at how this noisy gradient can be computed for a single data point.  First we write the ELBO in terms of a global term and a sum of local terms.</p>
<p><span class="math">\(\mathcal{L}(\lambda)=E_q[\log p(\beta)]-E_q[\log q(\beta)]+\sum^N_{n=1}\max(E_q[\log p(x_n,z_n | \beta)]-E_q[\log q(z_n)])\)</span></p>
<p>Consider a randomly chosen data point index <span class="math">\(I\)</span> sampled from <span class="math">\(Unif(1,...,N)\)</span>. For this data point <span class="math">\(x_{I}\)</span> let us define</p>
<p><span class="math">\(\mathcal{L}_I(\lambda)=E_q[\log p(\beta)]-E_q[\log q(\beta)]+N \max(E_q[\log p(x_I,z_I | \beta)]-E_q[\log q(z_I)])\)</span></p>
<p>This is equivalent to the original ELBO if the entire data set was made up of <span class="math">\(x_{I}\)</span>.  There are two important facts that one must understand about <span class="math">\(\mathcal{L}_I(\lambda)\)</span></p>
<p>The expectation of <span class="math">\(\mathcal{L}_I(\lambda)\)</span> with respect to the data point <span class="math">\(x_{I}\)</span> is equivalent to the original ELBO.
As a consequence, the gradient of <span class="math">\(\mathcal{L}_I(\lambda)\)</span> can be thought of as a noisy gradient of the original ELBO because it is unbiased.
However, we do not want to take the usual gradient of <span class="math">\(\mathcal{L}_I(\lambda)\)</span>.  Instead we want to take the natural gradient.  The usual gradient assumes that the parameter space is Euclidean but it turns out that it is better to assume that it has a Riemannian metric structure (in the context of minimizing KL divergence) which is what the natural gradient does.  A full explanation of the natural gradient is beyond the scope of this blog post but this paper by Amari gives a good overview.  The The natural gradient of  <span class="math">\(\mathcal{L}_I(\lambda)\)</span> is</p>
<p><span class="math">\(\nabla \mathcal{L}_i=E_q[\eta_g(x_i^{(N)},z_i^{(N)},\alpha)]-\lambda\)</span></p>
<p>and setting this gradient to zero gives the update</p>
<p>
<div class="math">$$\lambda=E_q[\eta_g(x_i^{(N)},z_i^{(N)},\alpha)]$$</div>
</p>
<p>The full algorithm is shown below</p>
<p><img alt="stochastic variational" src="images/stochastic_variational.png" /> </p>
<p>The procedure consists of sampling a single data point then finding the optimal local parameters for that data point then updating the global  variational parameters under the assumption that the entire dataset consisted of <span class="math">\(N\)</span> replicas of that data point.  Then this "intermediate" global variational parameter is combined with the previous "overall" global parameter via a weighted average to produce a new "overall" global parameter.  In this way, the global parameters can be updated after each sample is seen, rather than once after each iteration over the entire data set as in traditional variational inference (however, in pactice "mini-batches" of data points are used rather than a single point).  Now let's finally see how we can apply stochastic variational inference to Latent Dirichlet Allocation to get a scalable online learning algorithm.</p>
<h2>Stochastic Variational Inference and LDA</h2>
<p>Topic models aim to uncover the hidden thematic coherent topics that exist in a corpus of documents.  The most popular topic model is Latent Dirichlet Allocation (LDA).  In LDA, documents are thought of as distributions over topics and the topics themselves are distributions over words.  The graphical model for LDA can be thought of as a special case of the general graphical model shown earlier.  In the case of LDA, the global parameters are the topic distributions <span class="math">\(\beta\)</span>  which all documents depend on and the local parameters are the document-topic proportions <span class="math">\(\theta\)</span> which are independent between documents and <span class="math">\(Z\)</span> the topic assignments for each word in the document. So, in this context, "local" refers to document-specific variables and "global" refers to corpus-specific variables. The observed variables are the words that appear in each document (in bag-of-words format).  LDA is explained in greater detail in my previous blog post on the subject but here is the graphical model as a reminder.</p>
<p><img alt="lda graphical model" src="images/smoothed_lda.png" /> </p>
<p>In terms of notation, let's assume there are <span class="math">\(N\)</span> unique words in the vocabulary, <span class="math">\(D\)</span> documents in the corpus, and <span class="math">\(K\)</span> topics.  The next step is defining the complete conditionals for the LDA model (i.e. the distributions of each variable given all of the other variables both hidden and observed).  The complete conditionals for the local topic assignments <span class="math">\(Z\)</span>, the local topic proportions <span class="math">\(\theta\)</span>, and global topic distributions <span class="math">\(\beta\)</span> are</p>
<p><span class="math">\(p(z_{dn} | \theta_d,\phi_{1:K},w_{dn}) \propto \exp(\log \theta_{dk} + \log \beta_{k,w_{dn}})\)</span></p>
<p><span class="math">\(p(\theta_d | z_d)=Dirichlet(\alpha+\sum^N_{n=1}z_{dn})\)</span></p>
<p><span class="math">\(p(\beta_k | z,w)=Dirichlet(\eta +\sum^D_{d=1} \sum^N_{n=1}z^k_{dn}w_{dn})\)</span></p>
<p>where <span class="math">\(d\)</span> is the document index in the corpus, <span class="math">\(n\)</span> is the word index in the vocabulary, and <span class="math">\(k\)</span> is the topic index.  As you can see, the complete conditionals of the local variables only depend on other local variables from the same local context (i.e. the same document) and the global variables, they do not depend on local variables from other documents.  As per mean-field variational inference, the variational distributions for these variables take the same form as their complete conditionals, that is</p>
<p><span class="math">\(q(z_{dn})=Multinomial(\phi_{dn})\)</span></p>
<p><span class="math">\(q(\theta_d)=Dirichlet(\gamma_d)\)</span></p>
<p><span class="math">\(q(\beta_k)=Dirichlet(\lambda_k)\)</span></p>
<p>Next we find the updates for each of these variational parameters by taking the expectation of the natural parameters of the complete conditionals which are</p>
<p>
<div class="math">$$\phi^k_{dn}=\exp(\Psi(\gamma_{dk})+\Psi(\lambda_{k,w_{dn}})-\Psi(\sum_v \lambda_{kv}))$$</div>
</p>
<p>
<div class="math">$$\gamma_d=\alpha + \sum^N_{n=1}\phi_{dn}$$</div>
</p>
<p>
<div class="math">$$\lambda_k=\beta+\sum^D_{d=1} \sum^N_{n=1}\phi^k_{dn}w_{dn}$$</div>
</p>
<p>Now let's use the procedure mapped out in the stochastic variational inference algorithm which is to first randomly sample a document from the corpus then update the local variational parameters <span class="math">\(\phi\)</span> (the topic assignments for each word) and <span class="math">\(\gamma\)</span> (the topic proportions for the document) for this document.  Then we update the variational parameters for the global topic distribution for that sampled document <span class="math">\(\lambda\)</span>.  Then we merge the global parameter for the sampled document with the overall global parameter (with an update weighted by <span class="math">\(\rho_t\)</span>).  We repeat this procedure until we think that convergence has occurred.  This procedure is better illustrated below.</p>
<p><img alt="stochastic variational inference LDA" src="images/svi_lda.png" /> </p>
<h2>Experimental Results</h2>
<p>Scala code that implements stochastic variational inference for LDA can be found in this github repo (warning! experimental so use at your own risk).  In this experiment, we are using the NIPS dataset which consists of the abstracts of 1,736 NIPS papers however this algorithm could handle a much larger data set than this.  The following Scala code shows how we run this experiment.</p>
<div class="highlight"><pre><span class="c1">//set location of directory containing data</span>
 <span class="k">val</span> <span class="n">docDirectory</span> <span class="k">=</span> <span class="s">&quot;NIPS_dataset/&quot;</span>

<span class="c1">//create vocabulary from data with minimum frequency cutoff of 10</span>
 <span class="k">val</span> <span class="n">testVocab</span> <span class="k">=</span> <span class="nc">CountVocab</span><span class="o">(</span><span class="n">docDirectory</span><span class="o">,</span> <span class="mi">10</span><span class="o">).</span><span class="n">getVocabulary</span>

<span class="c1">//create a corpus object that can be streamed into online LDA model</span>
 <span class="k">val</span> <span class="n">testCorpus</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">StreamingCorpus</span><span class="o">(</span><span class="n">testVocab</span><span class="o">,</span> <span class="mi">5</span><span class="o">,</span> <span class="n">docDirectory</span><span class="o">)</span>

<span class="c1">//create online LDA model object with 5 topics, a decay of 0.5 and 1736 documents</span>
<span class="k">val</span> <span class="n">oldaTest</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">OnlineLDA</span><span class="o">(</span><span class="n">testCorpus</span><span class="o">,</span> <span class="mi">5</span><span class="o">,</span> <span class="mf">0.5</span><span class="o">,</span> <span class="mi">1736</span><span class="o">)</span>

<span class="c1">//learn the model</span>
 <span class="n">oldaTest</span><span class="o">.</span><span class="n">inference</span><span class="o">()</span>

<span class="c1">//show the topics by displaying the 10 most probable words in each topic</span>
 <span class="n">oldaTest</span><span class="o">.</span><span class="n">printTopics</span><span class="o">(</span><span class="mi">10</span><span class="o">)</span>
</pre></div>


<p>The resulting topics are shown below</p>
<div class="highlight"><pre>Topic 1: state, learning, reinforcement, policy, action, control, actions, states, controller, robot

Topic 2: recognition, speech, training, word, classifier, classification, classifiers, tree, words, hmm

Topic 3: cells, neurons, cell, neuron, visual, response, figure, synaptic, model, activity

Topic 4: network, learning, model, neural, data, networks, input, set, figure

Topic 5: disparity, binding, similarity, protein, structural, clause, instruction, energy, structure, spin
</pre></div>


<p>If you have some background knowledge in the machine learning domain you can see that these five topics are both distinct and thematically coherent.  The topics appear to describe five different fields of machine learning. Topic 1 seems to describe <a href="http://en.wikipedia.org/wiki/Reinforcement_learning">reinforcement learning</a>, Topic 2 seems to describe <a href="http://en.wikipedia.org/wiki/Speech_recognition">speech recognition</a>, Topic 3 seems to describe <a href="http://en.wikipedia.org/wiki/Computational_neuroscience">neuroscience</a> in general, Topic 4 seems to describe <a href="http://en.wikipedia.org/wiki/Artificial_neural_network">neural networks</a>, and finally Topic 5 seems to describe the field of <a href="http://en.wikipedia.org/wiki/Bioinformatics">bioinformatics</a>.  Some of the topics contain redundant words but this can be reduced by preprocessing the vocabulary (eg. word stemming).</p>
<h2>TL;DR</h2>
<ul>
<li>In traditional variational inference for LDA (and variational inference in general) we must iterate through the entire data set before we can update the global parameters.  This is slow and memory intensive.  It also turns out that it is unnecessary because the entire dataset contains redundant information - instead we can iteratively update our global parameters based on small samples from the data set.  This is much less memory intensive.</li>
<li>In terms of LDA, this means that we can iteratively update our model by learning sequentially from small mini-batches of documents taken from the corpus.  This means that at any given time, we only need to keep a small mini-batch of documents in memory which means that we can scale our LDA model to an arbitrarily large corpus!</li>
<li>Take a look at my <a href="https://github.com/alexminnaar/topic-models">experimental Scala</a> code that implements this.</li>
</ul>
<h2>References</h2>
<ul>
<li><a href="https://www.google.ca/url?sa=t&amp;rct=j&amp;q=&amp;esrc=s&amp;source=web&amp;cd=1&amp;cad=rja&amp;uact=8&amp;ved=0CB8QFjAA&amp;url=https%3A%2F%2Fwww.cs.princeton.edu%2F~blei%2Fpapers%2FHoffmanBleiBach2010b.pdf&amp;ei=Py88VJfcPIaeyASvkIDoCg&amp;usg=AFQjCNHLmU8Gk_P4usBj2QcGcaolw87w4w&amp;sig2=9dw5H6mIdznjjumz2nCY1g&amp;bvm=bv.77161500,d.aWw">Online Learning for Latent Dirichlet Allocation.  Hoffman, Blei, Bach.</a></li>
<li><a href="https://www.google.ca/url?sa=t&amp;rct=j&amp;q=&amp;esrc=s&amp;source=web&amp;cd=1&amp;cad=rja&amp;uact=8&amp;ved=0CCQQFjAA&amp;url=http%3A%2F%2Fwww.cs.princeton.edu%2F~blei%2Fpapers%2FHoffmanBleiWangPaisley2013.pdf&amp;ei=ci88VIuwKof5yAS2i4II&amp;usg=AFQjCNFDdMC1UFSKbIMPm8PSFWsuqnl4qg&amp;sig2=wxaruB5M5pLC5Tc_3QgxrA&amp;bvm=bv.77161500,d.aWw">Stochastic Variational Inference. Hoffman, Blei, Wang, Paisley.</a></li>
<li><a href="http://msc-ai-thesis-christiaan-meijer.googlecode.com/svn-history/trunk/Literature/Amari%20-%20Natural%20Gradient%20works%20efficiently%20in%20learning.pdf">Natural Gradient Works Efficiently in Learning. Amari.</a></li>
</ul>
<script type="text/javascript">if (!document.getElementById('mathjaxscript_pelican_#%@#$@#')) {
    var mathjaxscript = document.createElement('script');
    mathjaxscript.id = 'mathjaxscript_pelican_#%@#$@#';
    mathjaxscript.type = 'text/javascript';
    mathjaxscript.src = '//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML';
    mathjaxscript[(window.opera ? "innerHTML" : "text")] =
        "MathJax.Hub.Config({" +
        "    config: ['MMLorHTML.js']," +
        "    TeX: { extensions: ['AMSmath.js','AMSsymbols.js','noErrors.js','noUndefined.js'], equationNumbers: { autoNumber: 'AMS' } }," +
        "    jax: ['input/TeX','input/MathML','output/HTML-CSS']," +
        "    extensions: ['tex2jax.js','mml2jax.js','MathMenu.js','MathZoom.js']," +
        "    displayAlign: 'center'," +
        "    displayIndent: '0em'," +
        "    showMathMenu: true," +
        "    tex2jax: { " +
        "        inlineMath: [ ['\\\\(','\\\\)'] ], " +
        "        displayMath: [ ['$$','$$'] ]," +
        "        processEscapes: true," +
        "        preview: 'TeX'," +
        "    }, " +
        "    'HTML-CSS': { " +
        "        styles: { '.MathJax_Display, .MathJax .mo, .MathJax .mi, .MathJax .mn': {color: 'black ! important'} }" +
        "    } " +
        "}); ";
    (document.body || document.getElementsByTagName('head')[0]).appendChild(mathjaxscript);
}
</script>
                    </article>
 
<div class="paginator">
            <div class="navButton"> <a href="/author/alex-minnaar.html" >Prev</a></div>
    <div class="navButton">Page 2 / 5</div>
        <div class="navButton"><a href="/author/alex-minnaar3.html" >Next</a></div>
</div>
                </div>
            </aside><!-- /#featured -->
            
        
        <section id="extras" >
       
        
        </section><!-- /#extras -->
	
        <footer id="contentinfo" >
                <address id="about" class="vcard ">
                Proudly powered by <a href="http://getpelican.com/" target="_blank">Pelican</a>, which takes
                great advantage of <a href="http://python.org" target="_blank">Python</a>. &copy; <a class="url fn" href="http://launchyard.com">LaunchYard</a>
		
                </address><!-- /#about -->
		

                
        </footer><!-- /#contentinfo -->

<script type="text/javascript">
    var disqus_shortname = 'alexminnaar';
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = 'http://' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
</body>
</html>