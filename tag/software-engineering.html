<!DOCTYPE html>
<html lang="en">
<head>
        <title>Alex Minnaar's Blog - Machine Learning, Data Science and Software Engineering - Software Engineering</title>
        <meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <link rel="shortcut icon" href="http://launchyard.com/images/favicon.png"/>
        <link rel="stylesheet" href="/theme/css/main.css" type="text/css" />

        <!--[if IE]>
                <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

        <!--[if lte IE 7]>
                <link rel="stylesheet" type="text/css" media="all" href="/css/ie.css"/>
                <script src="/js/IE8.js" type="text/javascript"></script><![endif]-->

        <!--[if lt IE 7]>
                <link rel="stylesheet" type="text/css" media="all" href="/css/ie6.css"/><![endif]-->
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.8/jquery.min.js" type="text/javascript"></script>


</head>

<body id="index" class="home">
	
  <!--      <header id="banner" class="body">
                <h1><a href="/"><img src="http://www.launchyard.com/images/logo.png" /></a></h1>
        </header> -->
<!-- /#banner -->
	      <div class="LaunchyardDetail"><p><a href="/"></a>
<a class="title" href="http://alexminnaar.github.io/">Alex Minnaar</a>
<br/>
Machine Learning at University College London. Natural language processing at VerticalScope.
<br/>
<br/>
<a href="mailto:minnaaralex@gmail.com">Email</a><br />
<a href="https://github.com/alexminnaar">Github</a><br/>
<a href="https://ca.linkedin.com/pub/alex-minnaar/56/a23/853">LinkedIn</a><br/>
</p>


<div id="recent_posts">
			<h3>Categories</h3>
			<div align="left">
			<ul>
				<li><a href="/tag/nlp.html">NLP & Topic Models</a></li>
				<li><a href="/tag/supervised-learning.html">Supervised Learning</a></li>
				<li><a href="/tag/bayesian-inference.html">Bayesian Inference</a></li>
				<li><a href="/tag/kaggle-competitions.html">Kaggle Competitions</a></li>
				<li><a href="/tag/software-engineering.html">Software Engineering</a></li>
			</ul>
			</div>
              <h3>Recent Posts</h3>
                <a href="/introduction-to-the-multithreading-problem-and-the-akka-actor-solution.html">Introduction to the Multithreading Problem and the Akka Actor Solution  </a><br /><br />
                <a href="/scalaner-a-scala-wrapper-for-the-stanford-ner-tool-with-some-added-features.html">ScalaNER: A Scala Wrapper for the Stanford NER Tool with Some Added Features  </a><br /><br />
                <a href="/online-latent-dirichlet-allocation-the-best-option-for-topic-modeling-with-large-data-sets.html">Online Latent Dirichlet Allocation - The Best Option for Topic Modeling with Large Data Sets  </a><br /><br />
                <a href="/latent-dirichlet-allocation-in-scala-part-ii-the-code.html">Latent Dirichlet Allocation in Scala Part II - The Code </a><br /><br />
                <a href="/latent-dirichlet-allocation-in-scala-part-i-the-theory.html">Latent Dirichlet Allocation in Scala Part I - The Theory  </a><br /><br />
          </div>

</div>

        
        

    
            <aside id="featured">
                <div class="body">
                    <article>
                        <h1 class="entry-title"><a href="/introduction-to-the-multithreading-problem-and-the-akka-actor-solution.html">Introduction to the Multithreading Problem and the Akka Actor Solution</a></h1>
<div class="post-info">
	<ul>
        <li class="vcard author">
                 by&nbsp;<a class="url fn" href="/author/alex-minnaar.html">Alex Minnaar</a>
        </li>
        <li class="published" title="2014-12-27T00:00:00+01:00">
          on&nbsp;Sat 27 December 2014
        </li>

	</ul>
<p>Category: <a href="/tag/software-engineering.html">   Software Engineering</a></p>
</div><!-- /.post-info --><h2>The Multithreading Problem</h2>
<p>Nowadays, computers have multiple execution cores meaning that they can execute multiple tasks at the same time rather than sequentially.  Obviously this makes things much faster but it also presents some new problems.  The term <em>multithreading</em> refers to the process in which multiple threads execute code in the same program simultaneously.  The inherent problem with multithreading lies in the fact that although each thread acts independently, their memory is shared.  Therefore, it is possible for threads to change shared memory values without other threads knowing which can create problems.  Let's use a bank account as an example.  Consider the following code that implements a bank account with <code>deposit</code> and <code>withdraw</code> methods.</p>
<div class="highlight"><pre><span class="k">class</span> <span class="nc">BankAccount</span><span class="o">{</span>

    <span class="k">private</span> <span class="k">var</span> <span class="n">balance</span> <span class="k">=</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="n">deposit</span><span class="o">(</span><span class="n">amount</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span><span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span> 
        <span class="k">if</span> <span class="o">(</span><span class="n">amount</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="n">balance</span> <span class="k">=</span> <span class="n">balance</span> <span class="o">+</span> <span class="n">amount</span>

    <span class="k">def</span> <span class="n">withdraw</span><span class="o">(</span><span class="n">amount</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span><span class="k">:</span> <span class="kt">Int</span> <span class="o">=</span>
        <span class="k">if</span> <span class="o">(</span><span class="mi">0</span> <span class="o">&lt;</span> <span class="n">amount</span> <span class="o">&amp;&amp;</span> <span class="n">amount</span> <span class="o">&lt;=</span> <span class="n">balance</span><span class="o">){</span>
            <span class="n">balance</span> <span class="k">=</span> <span class="n">balance</span> <span class="o">-</span> <span class="n">amount</span>
            <span class="n">balance</span>
        <span class="o">}</span> <span class="k">else</span> <span class="k">throw</span> <span class="k">new</span> <span class="nc">Error</span><span class="o">(</span><span class="s">&quot;insufficient funds&quot;</span><span class="o">)</span>

<span class="o">}</span>
</pre></div>


<p>Here is a scenario where multithreading can cause problems.  Let's say that <code>balance</code>=40 dollars and <em>thread A</em> would like to withdraw 30 dollars. This satisfies both conditions in the <em>if</em> statement so <em>thread A</em> enters the code block where the 30 dollars is subtracted from the balance.  However, before <em>thread A</em> changes the balance, a second thread, <em>thread B</em>, wants to withdraw 20 dollars.  Since <em>thread A</em> has not yet changed the balance, <em>thread B</em> also satisfies the <em>if</em> statement and enters the code block where the balance can be changed.  So <em>thread A</em> subtracts $30 from the balance and then <em>thread B</em> subtracts 20 dollars from the balance leaving us with a balance of -10 dollars. Clearly, this is a problem!</p>
<p>Hopefully it is clear that the problem comes from the fact that the shared <em>balance</em> variable can be changed by any thread at any time so no thread can really be sure what value it holds.  One solution is for a thread to be able to reserve the memory values that it will be using so that no other thread can change them.  This is called <em>locking</em>.</p>
<h3>Using Locks (Synchronous)</h3>
<p>As stated previously, locking tries to solve the multithreading problem by <em>protecting</em> the shared memory value (in this case <code>balance</code>). Scala does this with <em>synchronization</em>.  Consider the same code as above but now each method definition is wrapped in <code>this.synchronized</code>.</p>
<div class="highlight"><pre><span class="k">class</span> <span class="nc">BankAccount</span><span class="o">{</span>

    <span class="k">private</span> <span class="k">var</span> <span class="n">balance</span> <span class="k">=</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="n">deposit</span><span class="o">(</span><span class="n">amount</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span><span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="n">synchronized</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">amount</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="n">balance</span> <span class="k">=</span> <span class="n">balance</span> <span class="o">+</span> <span class="n">amount</span>
    <span class="o">}</span>

    <span class="k">def</span> <span class="n">withdraw</span><span class="o">(</span><span class="n">amount</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span><span class="k">:</span> <span class="kt">Int</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="n">synchronized</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="mi">0</span> <span class="o">&lt;</span> <span class="n">amount</span> <span class="o">&amp;&amp;</span> <span class="n">amount</span> <span class="o">&lt;=</span> <span class="n">balance</span><span class="o">){</span>
            <span class="n">balance</span> <span class="k">=</span> <span class="n">balance</span> <span class="o">-</span> <span class="n">amount</span>
            <span class="n">balance</span>
        <span class="o">}</span> <span class="k">else</span> <span class="k">throw</span> <span class="k">new</span> <span class="nc">Error</span><span class="o">(</span><span class="s">&quot;insufficient funds&quot;</span><span class="o">)</span>
   <span class="o">}</span>

<span class="o">}</span>
</pre></div>


<p>Now <code>deposit</code> and <code>withdraw</code> each exit as one atomic unit meaning that only one thread can access them at a time (all others are blocked and must wait until the blocking thread is finished).  Now that all methods that can change <code>balance</code> are synchronized, conflicts such as the ones described above can no longer occur.  Unfortunately, the problem still is not completely solved because synchronization produces a few new problems.  For example, consider another <code>BankAccount</code> method called <code>transfer</code> which withdraws money from one account and deposits it into another with the following synchronized code.</p>
<div class="highlight"><pre><span class="k">def</span> <span class="n">transfer</span><span class="o">(</span><span class="n">from</span><span class="k">:</span> <span class="kt">BankAccount</span><span class="o">,</span> <span class="n">to</span><span class="k">:</span> <span class="kt">BankAccount</span><span class="o">,</span> <span class="n">amount</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span><span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span> <span class="o">{</span>
    <span class="n">from</span><span class="o">.</span><span class="n">synchronized</span> <span class="o">{</span>
        <span class="n">to</span><span class="o">.</span><span class="n">synchronized</span> <span class="o">{</span>
            <span class="n">from</span><span class="o">.</span><span class="n">withdraw</span><span class="o">(</span><span class="n">amount</span><span class="o">)</span>
            <span class="n">to</span><span class="o">.</span><span class="n">deposit</span><span class="o">(</span><span class="n">amount</span><span class="o">)</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>


<p>The withdrawal and deposit steps must be synchronized so that no thread can access the balance between withdrawal and deposit (at this point the amount transfered would not be anywhere).  The problem occurs when <em>thread A</em> wants to transfer money from <em>account A</em> to <em>account B</em> at the same time that <em>thread B</em> wants to transfer money from <em>account B</em> to <em>account A</em>.  When this happens <em>thread A</em> would lock <em>account A</em> and <em>thread B</em> would lock <em>account B</em> and each thread would wait for the other to release the lock which would take forever!  This is not good and it is called a <em>dead-lock</em> which is a common problem with synchronization.  There are ways of dealing with <em>dead-locks</em> but they are complicated and can make your code difficult to read.  In addition, stopping and starting threads when they become blocked turns out to be very bad for CPU utilization which will make your code run slower.  It would be much better if we could deal with this multithreading problem in such a way that we do not have to use any kind of blocking.  This is what the Akka actor model does.</p>
<h3>Using Actors (Asynchronous)</h3>
<p>Akka actors are fully encapsulated entities.  Changes to their internal state can only be done through passing known messages.  Message passing between actors is one-way and completely asynchronous (i.e. unblocking) so when an actor sends a message it does not have to wait for a reply, it can continue performing other tasks.  If multiple messages are sent to a single actor, it will process them sequentially in a queue (so internally an actor is single-threaded).  If a received message changes an actor's internal state, the change is reflected immediately after the message has been processed.  Therefore, processing one message is the atomic unit of execution (it can never be interrupted).</p>
<p>In terms of our bank account example, let's create a <code>BankAccount</code> actor that can receive <code>Deposit</code> and <code>Withdraw</code> messages.  In Scala, we create an actor by extending the <code>Actor</code> trait and implementing its <code>receive</code> method.  We must also define the messages that it can send and recieve in the actor's companion object.  The following is an actor-based <code>BankAccount</code> implementation.</p>
<div class="highlight"><pre><span class="k">object</span> <span class="nc">BankAccount</span> <span class="o">{</span>

  <span class="k">case</span> <span class="k">class</span> <span class="nc">Deposit</span><span class="o">(</span><span class="n">amount</span><span class="k">:</span> <span class="kt">BigInt</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">require</span><span class="o">(</span><span class="n">amount</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span>
  <span class="o">}</span>

  <span class="k">case</span> <span class="k">class</span> <span class="nc">Withdraw</span><span class="o">(</span><span class="n">amount</span><span class="k">:</span> <span class="kt">BigInt</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">require</span><span class="o">(</span><span class="n">amount</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span>
  <span class="o">}</span>

  <span class="k">case</span> <span class="k">object</span> <span class="nc">Done</span>

  <span class="k">case</span> <span class="k">object</span> <span class="nc">Failed</span>

<span class="o">}</span>

<span class="c1">//Actor that receives messages to perform actions of a bank account</span>
<span class="k">class</span> <span class="nc">BankAccount</span> <span class="k">extends</span> <span class="nc">Actor</span> <span class="o">{</span>

  <span class="k">import</span> <span class="nn">BankAccount._</span>

  <span class="k">var</span> <span class="n">balance</span> <span class="k">=</span> <span class="nc">BigInt</span><span class="o">(</span><span class="mi">0</span><span class="o">)</span>

  <span class="k">def</span> <span class="n">receive</span> <span class="k">=</span> <span class="nc">LoggingReceive</span> <span class="o">{</span>
    <span class="c1">//Deposit messages add amount to balance state</span>
    <span class="k">case</span> <span class="nc">Deposit</span><span class="o">(</span><span class="n">amount</span><span class="o">)</span> <span class="k">=&gt;</span>
      <span class="n">balance</span> <span class="o">+=</span> <span class="n">amount</span>
      <span class="n">sender</span> <span class="o">!</span> <span class="nc">Done</span>

    <span class="c1">//Withdraw messages subtract amount from balance state</span>
    <span class="k">case</span> <span class="nc">Withdraw</span><span class="o">(</span><span class="n">amount</span><span class="o">)</span> <span class="k">if</span> <span class="n">amount</span> <span class="o">&lt;=</span> <span class="n">balance</span> <span class="k">=&gt;</span>
      <span class="n">balance</span> <span class="o">-=</span> <span class="n">amount</span>
      <span class="n">sender</span> <span class="o">!</span> <span class="nc">Done</span>

    <span class="c1">//Any other message would return a failure to the sender</span>
    <span class="k">case</span> <span class="k">_</span> <span class="k">=&gt;</span> <span class="n">sender</span> <span class="o">!</span> <span class="nc">Failed</span>
  <span class="o">}</span>

<span class="o">}</span>
</pre></div>


<p>In the <code>BankAccount</code> companion object four messages are defined <code>Deposit</code>, <code>Withdraw</code>, <code>Done</code>, and <code>Failed</code>.  In the <code>receive</code> method in the <code>BankAccount</code> class defines how to change the <code>balance</code> variable when either the <code>Deposit</code> or the <code>Withdraw</code> method is received.  Once this is finished, a <code>Done</code> message is passed back to the actor that sent it via the <code>sender</code> variable (an actor's reference is always tied to the message it sends).  If any other message is received, then a <code>Failed</code> message is sent back to the sending actor.</p>
<p>But we also want to use an actor to transfer money between accounts.  You may remember that this had the potential to produce a <em>dead-lock</em> when done synchronously. We can avoid this using actors because now blocking is replaced with enqueuing messages.  Let's call this actor <code>WireTransfer</code>.  This actor can receive a <code>Transfer</code> message which contains three fields - a reference to the sending <code>BankAccount</code> actor, a reference to the receiving <code>BankAccount</code> actor, and the amount to be transferred.  When <code>WireTransfer</code> receives this message, it sends a <code>Withdraw</code> message (defined within the <code>BankAccount</code> companion object) to the sending actor, awaits a successful <code>Done</code> response, then sends a <code>Deposit</code> message to the recieving actor.  The following code implements the <code>WireTransfer</code> actor.</p>
<div class="highlight"><pre><span class="k">object</span> <span class="nc">WireTransfer</span> <span class="o">{</span>

  <span class="k">case</span> <span class="k">class</span> <span class="nc">Transfer</span><span class="o">(</span><span class="n">from</span><span class="k">:</span> <span class="kt">ActorRef</span><span class="o">,</span> <span class="n">to</span><span class="k">:</span> <span class="kt">ActorRef</span><span class="o">,</span> <span class="n">amount</span><span class="k">:</span> <span class="kt">BigInt</span><span class="o">)</span>

  <span class="k">case</span> <span class="k">object</span> <span class="nc">Done</span>

  <span class="k">case</span> <span class="k">object</span> <span class="nc">Failed</span>

<span class="o">}</span>

<span class="c1">//actor implementing the actions of a wire transfer between two bank account actors</span>
<span class="k">class</span> <span class="nc">WireTransfer</span> <span class="k">extends</span> <span class="nc">Actor</span> <span class="o">{</span>

  <span class="k">import</span> <span class="nn">WireTransfer._</span>

  <span class="k">def</span> <span class="n">receive</span> <span class="k">=</span> <span class="nc">LoggingReceive</span> <span class="o">{</span>
    <span class="c1">//If Transfer message is received, send withdraw message to &#39;from&#39; and wait for reply</span>
    <span class="k">case</span> <span class="nc">Transfer</span><span class="o">(</span><span class="n">from</span><span class="o">,</span> <span class="n">to</span><span class="o">,</span> <span class="n">amount</span><span class="o">)</span> <span class="k">=&gt;</span>
      <span class="n">from</span> <span class="o">!</span> <span class="nc">BankAccount</span><span class="o">.</span><span class="nc">Withdraw</span><span class="o">(</span><span class="n">amount</span><span class="o">)</span>
      <span class="n">context</span><span class="o">.</span><span class="n">become</span><span class="o">(</span><span class="n">awaitFrom</span><span class="o">(</span><span class="n">to</span><span class="o">,</span> <span class="n">amount</span><span class="o">,</span> <span class="n">sender</span><span class="o">))</span>
  <span class="o">}</span>

  <span class="c1">//If Withdraw was successful, send deposit to other bank account actor, or else give them a failure message</span>
  <span class="k">def</span> <span class="n">awaitFrom</span><span class="o">(</span><span class="n">to</span><span class="k">:</span> <span class="kt">ActorRef</span><span class="o">,</span> <span class="n">amount</span><span class="k">:</span> <span class="kt">BigInt</span><span class="o">,</span> <span class="n">customer</span><span class="k">:</span> <span class="kt">ActorRef</span><span class="o">)</span><span class="k">:</span> <span class="kt">Receive</span> <span class="o">=</span> <span class="nc">LoggingReceive</span> <span class="o">{</span>
    <span class="k">case</span> <span class="nc">BankAccount</span><span class="o">.</span><span class="nc">Done</span> <span class="k">=&gt;</span>
      <span class="n">to</span> <span class="o">!</span> <span class="nc">BankAccount</span><span class="o">.</span><span class="nc">Deposit</span><span class="o">(</span><span class="n">amount</span><span class="o">)</span>
      <span class="n">context</span><span class="o">.</span><span class="n">become</span><span class="o">(</span><span class="n">awaitTo</span><span class="o">(</span><span class="n">customer</span><span class="o">))</span>
    <span class="k">case</span> <span class="nc">BankAccount</span><span class="o">.</span><span class="nc">Failed</span> <span class="k">=&gt;</span>
      <span class="n">customer</span> <span class="o">!</span> <span class="nc">Failed</span>
      <span class="n">context</span><span class="o">.</span><span class="n">stop</span><span class="o">(</span><span class="n">self</span><span class="o">)</span>
  <span class="o">}</span>

  <span class="c1">//If deposit was successful, send &#39;Done&#39; to original actor that sent Transfer message</span>
  <span class="k">def</span> <span class="n">awaitTo</span><span class="o">(</span><span class="n">customer</span><span class="k">:</span> <span class="kt">ActorRef</span><span class="o">)</span><span class="k">:</span> <span class="kt">Receive</span> <span class="o">=</span> <span class="nc">LoggingReceive</span> <span class="o">{</span>
    <span class="k">case</span> <span class="nc">BankAccount</span><span class="o">.</span><span class="nc">Done</span> <span class="k">=&gt;</span>
      <span class="n">customer</span> <span class="o">!</span> <span class="nc">Done</span>
      <span class="n">context</span><span class="o">.</span><span class="n">stop</span><span class="o">(</span><span class="n">self</span><span class="o">)</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>


<p>When the actor first receives the <code>Transfer</code> message, it sends a <code>Withdraw</code> message to the <code>BankAccount</code> actor referenced in the <code>from</code> field of the message.  Then the actor must wait until a <code>Done</code> message is received (it does this with the <code>context.become()</code> method) at which point it sends a <code>Deposit</code> message to the other <code>BankAccount</code> actor.</p>
<p>We can also test this transfer process by creating a new actor that creates two <code>BankAccount</code> actors and a <code>WireTransfer</code> actor and then sends a <code>Transfer</code> message to the <code>WireTransfer</code> actor which references both of the <code>BankAccount</code> actors.  But before the <code>Transfer</code> message is sent, the actor must deposit some money in the first <code>BankAccount</code> actor so that there is some money available to transfer.  Let's call this actor <code>TransferMain</code> and here is its implementation.</p>
<div class="highlight"><pre><span class="k">class</span> <span class="nc">TransferMain</span> <span class="k">extends</span> <span class="nc">Actor</span> <span class="o">{</span>

  <span class="c1">//First create two BankAccount actors</span>
  <span class="k">val</span> <span class="n">accountA</span> <span class="k">=</span> <span class="n">context</span><span class="o">.</span><span class="n">actorOf</span><span class="o">(</span><span class="nc">Props</span><span class="o">[</span><span class="kt">BankAccount</span><span class="o">],</span> <span class="s">&quot;accountA&quot;</span><span class="o">)</span>
  <span class="k">val</span> <span class="n">accountB</span> <span class="k">=</span> <span class="n">context</span><span class="o">.</span><span class="n">actorOf</span><span class="o">(</span><span class="nc">Props</span><span class="o">[</span><span class="kt">BankAccount</span><span class="o">],</span> <span class="s">&quot;accountB&quot;</span><span class="o">)</span>

  <span class="c1">//send a deposit message to accountA</span>
  <span class="n">accountA</span> <span class="o">!</span> <span class="nc">BankAccount</span><span class="o">.</span><span class="nc">Deposit</span><span class="o">(</span><span class="mi">100</span><span class="o">)</span>

  <span class="c1">//If a &#39;Done&#39; message is received back, call a transfer function</span>
  <span class="k">def</span> <span class="n">receive</span> <span class="k">=</span> <span class="nc">LoggingReceive</span> <span class="o">{</span>
    <span class="k">case</span> <span class="nc">BankAccount</span><span class="o">.</span><span class="nc">Done</span> <span class="k">=&gt;</span> <span class="n">transfer</span><span class="o">(</span><span class="mi">70</span><span class="o">)</span>
  <span class="o">}</span>

  <span class="c1">//transfer function creates a transacton actor and sends a &#39;Transfer&#39; message to it between</span>
  <span class="c1">//accountA and accountB for the specified amount.</span>
  <span class="k">def</span> <span class="n">transfer</span><span class="o">(</span><span class="n">amount</span><span class="k">:</span> <span class="kt">BigInt</span><span class="o">)</span><span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span> <span class="o">{</span>

    <span class="k">val</span> <span class="n">transaction</span> <span class="k">=</span> <span class="n">context</span><span class="o">.</span><span class="n">actorOf</span><span class="o">(</span><span class="nc">Props</span><span class="o">[</span><span class="kt">WireTransfer</span><span class="o">],</span> <span class="s">&quot;transfer&quot;</span><span class="o">)</span>

    <span class="n">transaction</span> <span class="o">!</span> <span class="nc">WireTransfer</span><span class="o">.</span><span class="nc">Transfer</span><span class="o">(</span><span class="n">accountA</span><span class="o">,</span> <span class="n">accountB</span><span class="o">,</span> <span class="n">amount</span><span class="o">)</span>

    <span class="n">context</span><span class="o">.</span><span class="n">become</span><span class="o">(</span><span class="nc">LoggingReceive</span> <span class="o">{</span>
      <span class="k">case</span> <span class="nc">WireTransfer</span><span class="o">.</span><span class="nc">Done</span> <span class="k">=&gt;</span>
        <span class="n">println</span><span class="o">(</span><span class="s">&quot;successs&quot;</span><span class="o">)</span>
        <span class="n">context</span><span class="o">.</span><span class="n">stop</span><span class="o">(</span><span class="n">self</span><span class="o">)</span>
      <span class="k">case</span> <span class="nc">WireTransfer</span><span class="o">.</span><span class="nc">Failed</span> <span class="k">=&gt;</span>
        <span class="n">println</span><span class="o">(</span><span class="s">&quot;failed&quot;</span><span class="o">)</span>
        <span class="n">context</span><span class="o">.</span><span class="n">stop</span><span class="o">(</span><span class="n">self</span><span class="o">)</span>
    <span class="o">})</span>

  <span class="o">}</span>
<span class="o">}</span>
</pre></div>


<p>As you can see from the above code, 100 dollars is deposted in <code>accountA</code> via the <code>Deposit</code> message.  Then, when the <code>Done</code> message is recieved, the <code>transfer</code> function is called with an argument of 70 dollars.  Inside the <code>transfer</code> function, a <code>WireTransfer</code> actor is created and a <code>Transfer</code> message is sent to it with the appropriate arguments.  It then waits for either a <code>Done</code> or <code>Failed</code> message in return.</p>
<p>Hopefully this blog post has shed some light on the multithreading problem and how the Akka actor model tries to solve it.</p>
<h2>References</h2>
<ul>
<li>This bank account example was taken from the <a href="https://www.coursera.org/course/reactive">Principles of Reactive Programming</a> Coursera course.</li>
<li>The full code snippets can be found <a href="https://github.com/alexminnaar/Scala_Code_Snippets/tree/master/src/main/scala/BankAccount">on github</a>.</li>
</ul>
                    </article>
                </div>
            </aside><!-- /#featured -->
            
        
        

    
            <aside id="featured">
                <div class="body">
                    <article>
                        <h1 class="entry-title"><a href="/scalaner-a-scala-wrapper-for-the-stanford-ner-tool-with-some-added-features.html">ScalaNER: A Scala Wrapper for the Stanford NER Tool with Some Added Features</a></h1>
<div class="post-info">
	<ul>
        <li class="vcard author">
                 by&nbsp;<a class="url fn" href="/author/alex-minnaar.html">Alex Minnaar</a>
        </li>
        <li class="published" title="2014-11-11T00:00:00+01:00">
          on&nbsp;Tue 11 November 2014
        </li>

	</ul>
<p>Category: <a href="/tag/nlp.html">   NLP</a><a href="/tag/software-engineering.html">   Software Engineering</a></p>
</div><!-- /.post-info --><p>The <a href="http://nlp.stanford.edu/software/CRF-NER.shtml">Stanford NER (named entity recognizer) tool</a> is a widely-used, general purpose named entity recognition tool that Stanford has made available as part of its CoreNLP Java library.  It performs named entity recognition via a CRF-based sequence model which has been known to give near state-of-the-art performance results which makes it a popular choice for open-source NER tools.</p>
<p>Having said that, I have used this tool in the past and I was left wanting more functionality.  From its <a href="http://nlp.stanford.edu/software/crf-faq.shtml">FAQ section</a>, you can see that most of its functionality (i.e. training and testing a NER model) is designed to be performed using the command line.  But what if you want to use a pre-trained NER model as part of a real-time text processing pipeline?  For example, you are processing a string of text and you want to apply your NER model to the text and then do something with the tokens corresponding to classified named entities.  There is no clear way to do this with the Stanford NER tool.</p>
<p>I have also found that the Stanford NER tool is lacking in its model validation functionality.  Just like any classification model, I want to be able to perform cross-validation tests on my training data so that I can be confident in its generalized performance.  Again, there is no clear way of doing this.  You can test your model on a test set and obtain the precision, recall and F1 values but unfortunately these values are just shown in standard output and there is no way to persist them.  Consequently, if you wanted to perform 50-fold cross-validation on your dataset you would have to visually read each of the 50 sets of performance metrics off the screen and then manually average them to get your desired result (or export standard output and parse it).  Obviously no one wants to do this.</p>
<p><a href="https://github.com/alexminnaar/ScalaNER">ScalaNER</a> attempts to solve these problems by offering the following additional functionality to the Stanford NER tool.</p>
<ul>
<li>Programmatically apply a pre-trained NER model to a string of text and output the labelled result.</li>
<li>Programmatically train an NER model.</li>
<li>Easy model validation.  Specifically cross-validation.</li>
</ul>
<h2>ScalaNER Demo</h2>
<p>The following code samples demonstrate this new functionality.  First of all, it should be noted that the training data sets must be in the same format that the Stanford NER tool accepts.  That is, each line must contain a tab-separated token/label pair.  Entity labels can be any string but non-entity labels must be "O".  For example, training data for a person name entity might look like</p>
<div class="highlight"><pre>The    O
US    O
president    O
is    O
Barrack    NAME
Obama    NAME
</pre></div>


<p>where named entities are labelled as "NAME" and non-entity tokens are labelled as "O".</p>
<h3>Train an NER Model</h3>
<p>First we will demonstrate how to train a NER model given a training dataset in the format explained above.  The code is very simple - in fact it is only one line.  It uses a Scala object called <code>NERModel</code>.  To train an NER model you simply call this object's <code>trainClassifier</code> method which takes two arguments, the location of the training data file (it must be a text file) and the filename and location where the the trained NER model will be saved.</p>
<div class="highlight"><pre><span class="nc">NERModel</span><span class="o">.</span><span class="n">trainClassifier</span><span class="o">(</span><span class="s">&quot;my/data/location.txt&quot;</span><span class="o">,</span> <span class="s">&quot;save/my/model/here.ser.gz&quot;</span><span class="o">)</span>
</pre></div>


<h3>Apply an NER Model</h3>
<p>Then once you have trained your NER model you will probably want to apply this model to some new text.  To do this we use the <code>ApplyModel</code> class which takes the location of the trained model as a constructor.  Once this class has been instantiated, we call its <code>runNER</code> method which takes a string as an input argument.  This input string is the text from which you want to extract the named entities.  The result is an indexed sequence of <code>LabeledToken</code> objects which contain a token field and a label field.  The token fields contain the tokens in the input string and the label fields contain the named entities that the tokens have been assigned to.</p>
<div class="highlight"><pre><span class="k">val</span> <span class="n">classifier</span><span class="k">=new</span> <span class="nc">ApplyModel</span><span class="o">(</span><span class="s">&quot;my/pretrained/model.ser.gz&quot;</span><span class="o">)</span>

<span class="k">val</span> <span class="n">results</span><span class="k">=</span><span class="n">classifier</span><span class="o">.</span><span class="n">runNER</span><span class="o">(</span><span class="s">&quot;Find named entities in this new sentence.&quot;</span><span class="o">)</span>
</pre></div>


<h3>Performing Cross-Validation on an NER Model</h3>
<p>To perform cross-validation we use the CrossValidation class which takes the number of folds and training data location as constructors.  Then we call the <code>runCrossValidation</code> method with an input parameter that is the location of the directory where the training and validation sets will be written.  The result is a vector whose elements correspond to the number of folds.  Each element is a map whose keys represent the unique entity types in that fold and values represent the precision, recall and F1-score of the corresponding entity type.</p>
<div class="highlight"><pre><span class="k">val</span> <span class="n">testInstance</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">CrossValidation</span><span class="o">(</span><span class="mi">5</span><span class="o">,</span> <span class="s">&quot;location/of/training/data.txt&quot;</span><span class="o">)</span>

<span class="k">val</span> <span class="n">xvalResults</span><span class="k">=</span><span class="n">classifier</span><span class="o">.</span><span class="n">runCrossValidation</span><span class="o">(</span><span class="s">&quot;directory/to/write/xvalidation/data/&quot;</span><span class="o">)</span>
</pre></div>


<p>Next let's look at a real-world example.</p>
<h2>Example: Identifying Protein Names</h2>
<p>Suppose that you wanted to train an NER model to identify protein named in bio-medical literature.  We will use the BioNLP dataset that has already been transformed into the correct Stanford NER format which can be found in the <a href="https://github.com/alexminnaar/ScalaNER/tree/master/data">ScalaNER github repo</a>.</p>
<p>First let's try training an NER model with this data and running it on a sample string of text to determine if it contains any protein names.</p>
<div class="highlight"><pre><span class="nc">NERModel</span><span class="o">.</span><span class="n">trainClassifier</span><span class="o">(</span><span class="s">&quot;data/bionlp.txt&quot;</span><span class="o">,</span> <span class="s">&quot;/bioNlpModel.ser.gz&quot;</span><span class="o">)</span>

<span class="k">val</span> <span class="n">classifier</span><span class="k">=new</span> <span class="nc">ApplyModel</span><span class="o">(</span><span class="s">&quot;/bioNlpModel.ser.gz&quot;</span><span class="o">)</span>

<span class="k">val</span> <span class="n">results</span><span class="k">=</span><span class="n">classifier</span><span class="o">.</span><span class="n">runNER</span><span class="o">(</span><span class="s">&quot;Leukotriene B4 stimulates c-fos and c-jun gene transcription and AP-1 binding activity in human monocytes.&quot;</span><span class="o">)</span>

<span class="n">println</span><span class="o">(</span><span class="n">results</span><span class="o">)</span>
</pre></div>


<p>Which gives the following output</p>
<p><code>Vector(LabeledToken(Leukotriene,O), LabeledToken(B4,O), LabeledToken(stimulates,O), LabeledToken(c-fos,protein), LabeledToken(and,O), LabeledToken(c-jun,protein), LabeledToken(gene,O), LabeledToken(transcription,O), LabeledToken(and,O), LabeledToken(AP-1,O), LabeledToken(binding,O), LabeledToken(activity,O), LabeledToken(in,O), LabeledToken(human,O), LabeledToken(monocytes,O), LabeledToken(.,O))</code></p>
<p>As you can see, the trained model assigns the correct <em>protein</em> label to the tokens "c-fos" and "c-jun" and all other tokens are assigned the <em>O</em> label indicating that they are not named entities.</p>
<p>Next, let's perform 5-fold cross-validation on the entire dataset to get a good idea of its generalized performance.  This can be done in the following code where we specify the folder "data/xval" to be location where the 5 training and validation sets will be written.</p>
<div class="highlight"><pre><span class="k">val</span> <span class="n">cv</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">CrossValidation</span><span class="o">(</span><span class="mi">5</span><span class="o">,</span> <span class="s">&quot;data/bionlp.txt&quot;</span><span class="o">)</span>

<span class="k">val</span> <span class="n">testResults</span> <span class="k">=</span> <span class="n">cv</span><span class="o">.</span><span class="n">runCrossValidation</span><span class="o">(</span><span class="s">&quot;data/xval&quot;</span><span class="o">)</span>

<span class="n">println</span><span class="o">(</span><span class="n">testResults</span><span class="o">)</span>
</pre></div>


<p>Which gives the following output</p>
<p><code>Vector(Map(protein -&gt; Performance(0.680461329715061,0.9862340216322517,0.8052990766760337), O -&gt; Performance(0.999634483838964,0.9878479836941098,0.9937062846316554)), Map(O -&gt; Performance(0.9991162403826159,0.9858425237240318,0.9924350003872866), protein -&gt; Performance(0.5766871165644172,0.9567430025445293,0.7196172248803828)), Map(O -&gt; Performance(0.9986442092089483,0.9858183409260546,0.9921898273472612), protein -&gt; Performance(0.6125175808720112,0.9436619718309859,0.7428571428571428)), Map(O -&gt; Performance(0.9994266652767643,0.9878419452887538,0.9936005389019872), protein -&gt; Performance(0.6638176638176638,0.9769392033542977,0.7905004240882104)), Map(O -&gt; Performance(0.9988831168831169,0.9877484974572354,0.9932846036624738), protein -&gt; Performance(0.6261755485893417,0.9489311163895487,0.7544853635505192)))</code></p>
<p>The above output shows the precision, recall and F1-scores for each entity type (in this case protein and O) and each of the 5 folds.  So the F1-scores associated with identifying <em>protein</em> named entities are 0.8052, 0.7196, 0.7428, 0.7905, and 0.7544 for an average F1-score of 0.7625.</p>
<h2>References</h2>
<ul>
<li><a href="http://nlp.stanford.edu/software/CRF-NER.shtml">Stanford Named Entity Recognizer</a></li>
<li><a href="https://github.com/alexminnaar/ScalaNER">ScalaNER Github Repo</a></li>
</ul>
                    </article>
 
<div class="paginator">
    <div class="navButton">Page 1 / 1</div>
</div>
                </div>
            </aside><!-- /#featured -->
            
        
        <section id="extras" >
       
        
        </section><!-- /#extras -->
	
        <footer id="contentinfo" >
                <address id="about" class="vcard ">
                Proudly powered by <a href="http://getpelican.com/" target="_blank">Pelican</a>, which takes
                great advantage of <a href="http://python.org" target="_blank">Python</a>. &copy; <a class="url fn" href="http://launchyard.com">LaunchYard</a>
		
                </address><!-- /#about -->
		

                
        </footer><!-- /#contentinfo -->

<script type="text/javascript">
    var disqus_shortname = 'alexminnaar';
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = 'http://' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
</body>
</html>